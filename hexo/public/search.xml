<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title><![CDATA[gitlab本地部署]]></title>
      <url>/2018/02/20/gitlab%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2/</url>
      <content type="html"><![CDATA[<h2 id="安装和配置必要的依赖">安装和配置必要的依赖</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1">[<span class="ex">root@centos-7</span> ~]# yum install postfix </a>
<a class="sourceLine" id="cb1-2" data-line-number="2">[<span class="ex">root@centos-7</span> ~]# systemctl start postfix</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">[<span class="ex">root@centos-7</span> ~]# systemctl enable postfix</a></code></pre></div>
<p>如果postfix启动不起来，提示no local interface found for ::1。可以修改下 /etc/postfix/main.cf中inet_interfaces = all。</p>
<h2 id="添加gitlab的仓库并安装包">添加gitlab的仓库并安装包</h2>
<h3 id="执行脚本添加">执行脚本添加</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" data-line-number="1">[<span class="ex">root@centos-7</span> ~]# curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.rpm.sh <span class="kw">|</span> <span class="fu">sudo</span> bash</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">[<span class="ex">root@centos-7</span> ~]# yum -y install gitlab-ce</a></code></pre></div>
<div class="note">
<div class="admonition-title">
<p>Note</p>
</div>
<p>这个包大概440M大小，需要一定的等待时间。</p>
</div>
<h3 id="手工添加">手工添加</h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" data-line-number="1">[<span class="ex">root@centos-7</span> yum.repos.d]# vim gitlab-ce.repo</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">[<span class="ex">gitlab-ce</span>]</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="va">name=</span>Gitlab <span class="ex">CE</span> Repository</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="va">baseurl=</span>https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="va">gpgcheck=</span>0</a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="va">enabled=</span>1</a></code></pre></div>
<p>这个使用清华的镜像，没有使用国外的，下载可能会快点。</p>
<h3 id="修改配置文件的url">修改配置文件的url</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" data-line-number="1">[<span class="ex">root@centos-7</span> src]# vim /etc/gitlab/gitlab.rb </a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="ex">external_url</span> <span class="st">&#39;http://localhost&#39;</span></a></code></pre></div>
<h2 id="启动下gitlab">启动下gitlab</h2>
<p>启动gitlab</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" data-line-number="1">[<span class="ex">root@centos-7</span> src]# systemctl enable gitlab-runsvdir.service</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">[<span class="ex">root@centos-7</span> src]# gitlab-ctl  reconfigure</a></code></pre></div>
<p>这个配置大概需要10多分钟，耐心等待，我是centos7的系统，安装一直有问题。</p>
<p>错误修复</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" data-line-number="1">[<span class="ex">root@www</span> ~]# yum install gem </a>
<a class="sourceLine" id="cb6-2" data-line-number="2">[<span class="ex">root@www</span> ~]# gem sources --add https://gems.ruby-china.org/ --remove https://rubygems.org/</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">[<span class="ex">root@centos-7</span> src]# gitlab-ctl  reconfigure</a></code></pre></div>
<h2 id="测试">测试</h2>
<p><img src="/images/git/gitlab登陆.png" alt="image"></p>
<p>登陆账号root,密码：5iveL!fe</p>
<p><img src="/images/git/gitlab修改密码.png" alt="image"></p>
<p><img src="/images/git/gitlab登陆2.png" alt="image"></p>
<p><img src="/images/git/gitlab主页.png" alt="image"></p>
<h2 id="禁止注册">禁止注册</h2>
<p>公司内部是禁止注册的，需要的话练习管理员给开账号。</p>
<p><img src="/images/git/gitlab禁止注册.png" alt="image"></p>
<h2 id="参考">参考</h2>
<p><a href="https://about.gitlab.com/installation/" target="_blank" rel="noopener">官方参考</a></p>
]]></content>
      
        <categories>
            
            <category> linux </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> git </tag>
            
            <tag> gitlab </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[gitbucket本地部署]]></title>
      <url>/2018/02/20/gitbucket%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2/</url>
      <content type="html"><![CDATA[<h2 id="下载软件包">下载软件包</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1">[<span class="ex">root@centos-7</span> src]# wget https://github.com/gitbucket/gitbucket/archive/4.21.2.tar.gz</a></code></pre></div>
<h2 id="运行服务">运行服务</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" data-line-number="1">[<span class="ex">root@centos-150</span> src]# java -jar gitbucket.war</a></code></pre></div>
<h2 id="测试">测试</h2>
<p><img src="/images/git/gitbucket主页.png" alt="image"></p>
<p><img src="/images/git/gitbucket登录.png" alt="image"></p>
<p><img src="/images/git/gitbucket创建仓库.png" alt="image"></p>
<p><img src="/images/git/gitbucket效果图.png" alt="image"></p>
<h2 id="参考">参考</h2>
<p><a href="https://github.com/gitbucket/gitbucket#installation" target="_blank" rel="noopener">官方安装指南</a></p>
]]></content>
      
        <categories>
            
            <category> linux </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> git </tag>
            
            <tag> gitbucket </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[lamp一键编译安装]]></title>
      <url>/2018/02/18/lamp%E4%B8%80%E9%94%AE%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/</url>
      <content type="html"><![CDATA[<h2 id="安装">安装</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="ex">curl</span> https://raw.githubusercontent.com/zhaojiedi1992/lamp/master/install.sh  <span class="kw">|</span> <span class="fu">bash</span> </a></code></pre></div>
<p>代码托管在github上。 <a href="https://github.com/zhaojiedi1992/lamp" target="_blank" rel="noopener">地址</a></p>
]]></content>
      
        <categories>
            
            <category> linux </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[lamp实战一]]></title>
      <url>/2018/02/18/lamp%E5%AE%9E%E6%88%98%E4%B8%80/</url>
      <content type="html"><![CDATA[<p>这个实战是我在 <a href="http://www.magedu.com/" target="_blank" rel="noopener">马哥教育</a> 培训中期，给的实战题目，相对比较简单。</p>
<h2 id="架构图">架构图</h2>
<p><img src="/images/web/实战1架构图.png" alt="image"></p>
<ul>
<li>dns完成解析web1,web2来实现负载均衡</li>
<li>web1,web2使用后台的mysql数据库</li>
<li>web1,web2的页面数据全部放在nfs数据上，实现自动挂载</li>
<li>nfs服务器为web1,web2提供网页数据</li>
</ul>
<h2 id="准备工作">准备工作</h2>
<p>设置ip信息</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="ex">nmcli</span> con add ifname ens33 con-name ens33 type ethernet ipv4.method manual \</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">ipv4.address 192.158.46.150/24 ipv4.gateway 192.168.46.1</a></code></pre></div>
<div class="note">
<div class="admonition-title">
<p>Note</p>
</div>
<p>我使用的nmcli修改的ip，当然也是可以手工修改的。</p>
</div>
<h2 id="ansible的配置">ansible的配置</h2>
<h3 id="安装ansible">安装ansible</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" data-line-number="1">[<span class="ex">root@localhost</span> ~]# yum install ansible</a></code></pre></div>
<h3 id="添加主机">添加主机</h3>
<p>需要添加如下内容到/etc/ansible/hosts文件中去。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">[client]</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="dt">192.168.46.159</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw">[dns]</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="dt">192.168.46.158</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="kw">[web]</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="dt">192.168.46.157</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="dt">192.168.46.156</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="kw">[db]</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="dt">192.168.46.155</span></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="kw">[nfs]</span></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="dt">192.168.46.154</span></a>
<a class="sourceLine" id="cb3-14" data-line-number="14"><span class="kw">[self]</span></a>
<a class="sourceLine" id="cb3-15" data-line-number="15"><span class="dt">192.168.46.150</span></a></code></pre></div>
<h3 id="配置免密码登陆">配置免密码登陆</h3>
<p>这里我之前写有一个脚本自动完成免密码登陆的脚本，参考我的博客_</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" data-line-number="1">[<span class="ex">root@localhost</span> ~]# cat hosts.txt </a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="ex">192.168.46.150</span> root oracle</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="ex">192.168.46.151</span> root oracle</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="ex">192.168.46.152</span> root oracle</a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="ex">192.168.46.153</span> root oracle</a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="ex">192.168.46.154</span> root oracle</a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="ex">192.168.46.155</span> root oracle</a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="ex">192.168.46.156</span> root oracle</a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="ex">192.168.46.157</span> root oracle</a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="ex">192.168.46.158</span> root oracle</a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="ex">192.168.46.159</span> root oracle</a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="ex">192.168.46.160</span> root oracle</a>
<a class="sourceLine" id="cb4-13" data-line-number="13">[<span class="ex">root@localhost</span> ~]# cat mima.sh </a>
<a class="sourceLine" id="cb4-14" data-line-number="14"><span class="co">#!/bin/bash </span></a>
<a class="sourceLine" id="cb4-15" data-line-number="15"><span class="co">#================================================</span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16"><span class="co">#FileName   :expect_ssh.sh</span></a>
<a class="sourceLine" id="cb4-17" data-line-number="17"><span class="co">#Author     :zhaojiedi</span></a>
<a class="sourceLine" id="cb4-18" data-line-number="18"><span class="co">#Description:</span></a>
<a class="sourceLine" id="cb4-19" data-line-number="19"><span class="co">#DateTime   :2018-01-05 08:26:06</span></a>
<a class="sourceLine" id="cb4-20" data-line-number="20"><span class="co">#Version    :V1.0</span></a>
<a class="sourceLine" id="cb4-21" data-line-number="21"><span class="co">#Other      :</span></a>
<a class="sourceLine" id="cb4-22" data-line-number="22"><span class="co">#================================================</span></a>
<a class="sourceLine" id="cb4-23" data-line-number="23"><span class="va">host_username_password_file=</span>hosts.txt</a>
<a class="sourceLine" id="cb4-24" data-line-number="24"></a>
<a class="sourceLine" id="cb4-25" data-line-number="25"><span class="co"># install expect </span></a>
<a class="sourceLine" id="cb4-26" data-line-number="26"><span class="ex">rpm</span> -q expect <span class="op">&amp;&gt;</span>/dev/null <span class="kw">||</span> <span class="ex">yum</span> install -yq expect <span class="op">&amp;&gt;</span>/dev/null</a>
<a class="sourceLine" id="cb4-27" data-line-number="27"></a>
<a class="sourceLine" id="cb4-28" data-line-number="28"><span class="co"># create id_rsa.pub file </span></a>
<a class="sourceLine" id="cb4-29" data-line-number="29"><span class="va">pubkey=</span>~/.ssh/id_rsa.pub</a>
<a class="sourceLine" id="cb4-30" data-line-number="30"><span class="kw">if</span><span class="bu"> [</span> <span class="ot">!</span> <span class="ot">-e</span> <span class="st">&quot;</span><span class="va">$pubkey</span><span class="st">&quot;</span><span class="bu"> ]</span> ; <span class="kw">then</span></a>
<a class="sourceLine" id="cb4-31" data-line-number="31">        <span class="fu">ssh-keygen</span>  -P <span class="st">&quot;&quot;</span> -t rsa  -f ~/.ssh/id_rsa</a>
<a class="sourceLine" id="cb4-32" data-line-number="32"><span class="kw">fi</span></a>
<a class="sourceLine" id="cb4-33" data-line-number="33"><span class="kw">while</span> <span class="bu">read</span> <span class="va">host</span> <span class="va">username</span> <span class="va">password</span> ; <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-34" data-line-number="34">        <span class="va">con=${username}</span><span class="st">&quot;@&quot;</span><span class="va">${host}</span></a>
<a class="sourceLine" id="cb4-35" data-line-number="35">        <span class="bu">echo</span> <span class="va">$password</span></a>
<a class="sourceLine" id="cb4-36" data-line-number="36">        <span class="ex">expect</span> <span class="op">&lt;&lt;EOF</span></a>
<a class="sourceLine" id="cb4-37" data-line-number="37">        set timeout 20 </a>
<a class="sourceLine" id="cb4-38" data-line-number="38">        spawn ssh-copy-id <span class="va">$con</span></a>
<a class="sourceLine" id="cb4-39" data-line-number="39">        expect {</a>
<a class="sourceLine" id="cb4-40" data-line-number="40">                &quot;yes/no&quot;  { send &quot;yes\n&quot; ; exp_continue }</a>
<a class="sourceLine" id="cb4-41" data-line-number="41">                &quot;password:&quot; { send &quot;<span class="va">${password}</span>\n&quot;; exp_continue }</a>
<a class="sourceLine" id="cb4-42" data-line-number="42">        }</a>
<a class="sourceLine" id="cb4-43" data-line-number="43">EOF</a>
<a class="sourceLine" id="cb4-44" data-line-number="44">done &lt; <span class="va">$host_username_password_file</span></a>
<a class="sourceLine" id="cb4-45" data-line-number="45"></a>
<a class="sourceLine" id="cb4-46" data-line-number="46"># 执行下脚本，自动完成公钥copy工作了</a>
<a class="sourceLine" id="cb4-47" data-line-number="47">[root@localhost ~]# bash mima.sh </a>
<a class="sourceLine" id="cb4-48" data-line-number="48"></a>
<a class="sourceLine" id="cb4-49" data-line-number="49"># 测试下</a>
<a class="sourceLine" id="cb4-50" data-line-number="50">[root@localhost ~]# ssh 192.168.46.151 &#39;ip a show ens33&#39;</a></code></pre></div>
<h3 id="设置主机名可选">设置主机名（可选）</h3>
<p>我这里的机器全是刚刚克隆出来的虚拟机，为了管理方便设置下主机名，防止误操作。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># 创建一个设置主机名的脚本</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">[<span class="ex">root@localhost</span> ~]# vim set_hostname.sh </a>
<a class="sourceLine" id="cb5-3" data-line-number="3">[<span class="ex">root@localhost</span> ~]# cat set_hostname.sh </a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="co">#!/bin/bash</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="bu">echo</span> <span class="st">&quot;start&quot;</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="fu">hostname</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="va">name=</span>centos-<span class="va">$(</span><span class="ex">ip</span> a show ens33 <span class="kw">|</span><span class="fu">grep</span> <span class="st">&#39;inet.*ens33&#39;</span> <span class="kw">|</span> <span class="fu">sed</span> -r  -n <span class="st">&#39;s@.*\.([0-9]{1,3})/.*@\1@p&#39;</span><span class="va">)</span>.linuxpanda.tech</a>
<a class="sourceLine" id="cb5-8" data-line-number="8"><span class="bu">echo</span> <span class="va">$name</span></a>
<a class="sourceLine" id="cb5-9" data-line-number="9"><span class="ex">hostnamectl</span> set-hostname <span class="va">$name</span></a>
<a class="sourceLine" id="cb5-10" data-line-number="10"><span class="bu">echo</span> <span class="st">&quot;end&quot;</span></a>
<a class="sourceLine" id="cb5-11" data-line-number="11"></a>
<a class="sourceLine" id="cb5-12" data-line-number="12">[<span class="ex">root@centos-localhost</span> ~]# ansible all -m script -a <span class="st">&#39;/root/set_hostname.sh&#39;</span></a></code></pre></div>
<p>这个脚本也是设置了ansible主机的ip。</p>
<h3 id="防火墙和selinux关闭">防火墙和selinux关闭</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co"># 关闭防火墙</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">[<span class="ex">root@centos-150</span> ~]# ansible all -m service -a <span class="st">&#39;name=firewalld enabled=no&#39;</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">[<span class="ex">root@centos-150</span> ~]# ansible all -m service -a <span class="st">&#39;name=firewalld state=stopped&#39;</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"></a>
<a class="sourceLine" id="cb6-5" data-line-number="5">[<span class="ex">root@centos-150</span> ~]# ansible all -m shell -a <span class="st">&#39;sed  -i -r &#39;</span>s@SELINUX=.*@SELINUX=disabled@<span class="st">&#39; /etc/sysconfig/selinux&#39;</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6">[<span class="ex">root@centos-150</span> ~]# ansible all -m shell -a  <span class="st">&#39;setenforce 0&#39;</span></a></code></pre></div>
<div class="note">
<div class="admonition-title">
<p>Note</p>
</div>
<p>如果原有selinux就是disabled，使用setenforce 0会报错误的，不用管它。</p>
</div>
<h2 id="dns主机设置">dns主机设置</h2>
<h3 id="dns配置">dns配置</h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb7-1" data-line-number="1">[<span class="ex">root@centos-158</span> ~]# yum install bind bind-utils</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">[<span class="ex">root@centos-158</span> ~]# vim /etc/named.conf</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="co"># 注释如下5行</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="ex">//</span>      listen-on port 53 { 127.0.0.1<span class="kw">;</span> };</a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="ex">//</span>      listen-on-v6 port 53 { ::1<span class="kw">;</span> };</a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="ex">//</span>      allow-query     { localhost<span class="kw">;</span> };</a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="ex">//</span>      dnssec-enable yes<span class="kw">;</span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8"><span class="ex">//</span>      dnssec-validation yes<span class="kw">;</span></a>
<a class="sourceLine" id="cb7-9" data-line-number="9">[<span class="ex">root@centos-158</span> ~]# vim /etc/named.rfc1912.zones </a>
<a class="sourceLine" id="cb7-10" data-line-number="10"><span class="co"># 添加如下内容，注意之后的分号</span></a>
<a class="sourceLine" id="cb7-11" data-line-number="11"><span class="ex">zone</span> <span class="st">&quot;linuxpanda.tech&quot;</span> IN {</a>
<a class="sourceLine" id="cb7-12" data-line-number="12">        <span class="bu">type</span> master<span class="kw">;</span></a>
<a class="sourceLine" id="cb7-13" data-line-number="13">        <span class="fu">file</span> <span class="st">&quot;linuxpanda.tech.zone&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb7-14" data-line-number="14">};</a>
<a class="sourceLine" id="cb7-15" data-line-number="15">[<span class="ex">root@centos-158</span> ~]# cd /var/named/</a>
<a class="sourceLine" id="cb7-16" data-line-number="16">[<span class="ex">root@centos-158</span> named]# cp -a named.localhost  linuxpanda.tech.zone</a>
<a class="sourceLine" id="cb7-17" data-line-number="17">[<span class="ex">root@centos-158</span> named]# vim linuxpanda.tech.zone </a>
<a class="sourceLine" id="cb7-18" data-line-number="18">[<span class="ex">root@centos-158</span> named]# cat linuxpanda.tech.zone </a>
<a class="sourceLine" id="cb7-19" data-line-number="19"><span class="va">$TTL</span> <span class="ex">1D</span></a>
<a class="sourceLine" id="cb7-20" data-line-number="20"><span class="ex">@</span>   IN SOA  ns1 admin (</a>
<a class="sourceLine" id="cb7-21" data-line-number="21">                    <span class="ex">0</span>   <span class="kw">;</span> <span class="ex">serial</span></a>
<a class="sourceLine" id="cb7-22" data-line-number="22">                    <span class="ex">1D</span>  <span class="kw">;</span> <span class="ex">refresh</span></a>
<a class="sourceLine" id="cb7-23" data-line-number="23">                    <span class="ex">1H</span>  <span class="kw">;</span> <span class="ex">retry</span></a>
<a class="sourceLine" id="cb7-24" data-line-number="24">                    <span class="ex">1W</span>  <span class="kw">;</span> <span class="ex">expire</span></a>
<a class="sourceLine" id="cb7-25" data-line-number="25">                    <span class="ex">3H</span> )    ; <span class="ex">minimum</span></a>
<a class="sourceLine" id="cb7-26" data-line-number="26">    <span class="ex">NS</span>  ns1</a>
<a class="sourceLine" id="cb7-27" data-line-number="27"><span class="ex">ns1</span>     A       192.168.46.158</a>
<a class="sourceLine" id="cb7-28" data-line-number="28"><span class="ex">web</span>     A       192.168.46.157</a>
<a class="sourceLine" id="cb7-29" data-line-number="29"><span class="ex">web</span>     A       192.168.46.156</a>
<a class="sourceLine" id="cb7-30" data-line-number="30"><span class="ex">www</span>     CNAME   web</a></code></pre></div>
<h3 id="dns本机测试">dns本机测试</h3>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb8-1" data-line-number="1">[<span class="ex">root@centos-158</span> named]# dig www.linuxpanda.tech @localhost</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"></a>
<a class="sourceLine" id="cb8-3" data-line-number="3">; <span class="op">&lt;&lt;&gt;&gt;</span> <span class="ex">DiG</span> 9.9.4-RedHat-9.9.4-51.el7_4.2 <span class="op">&lt;&lt;&gt;&gt;</span> www.linuxpanda.tech @localhost</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">;; <span class="ex">global</span> options: +cmd</a>
<a class="sourceLine" id="cb8-5" data-line-number="5">;; <span class="ex">Got</span> answer:</a>
<a class="sourceLine" id="cb8-6" data-line-number="6">;; <span class="ex">-</span><span class="op">&gt;&gt;</span>HEADER<span class="op">&lt;&lt;- opcode:</span> <span class="ex">QUERY</span>, status: NOERROR, id: 57957</a>
<a class="sourceLine" id="cb8-7" data-line-number="7">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 1, ADDITIONAL: 2</a>
<a class="sourceLine" id="cb8-8" data-line-number="8"></a>
<a class="sourceLine" id="cb8-9" data-line-number="9">;; OPT PSEUDOSECTION:</a>
<a class="sourceLine" id="cb8-10" data-line-number="10">; EDNS: version: 0, flags:; udp: 4096</a>
<a class="sourceLine" id="cb8-11" data-line-number="11">;; QUESTION SECTION:</a>
<a class="sourceLine" id="cb8-12" data-line-number="12">;www.linuxpanda.tech.       IN  A</a>
<a class="sourceLine" id="cb8-13" data-line-number="13"></a>
<a class="sourceLine" id="cb8-14" data-line-number="14">;; ANSWER SECTION:</a>
<a class="sourceLine" id="cb8-15" data-line-number="15">www.linuxpanda.tech.    86400   IN  CNAME   web.linuxpanda.tech.</a>
<a class="sourceLine" id="cb8-16" data-line-number="16">web.linuxpanda.tech.    86400   IN  A   192.168.46.156</a>
<a class="sourceLine" id="cb8-17" data-line-number="17">web.linuxpanda.tech.    86400   IN  A   192.168.46.157</a>
<a class="sourceLine" id="cb8-18" data-line-number="18"></a>
<a class="sourceLine" id="cb8-19" data-line-number="19">;; AUTHORITY SECTION:</a>
<a class="sourceLine" id="cb8-20" data-line-number="20">linuxpanda.tech.    86400   IN  NS  ns1.linuxpanda.tech.</a>
<a class="sourceLine" id="cb8-21" data-line-number="21"></a>
<a class="sourceLine" id="cb8-22" data-line-number="22">;; ADDITIONAL SECTION:</a>
<a class="sourceLine" id="cb8-23" data-line-number="23">ns1.linuxpanda.tech.    86400   IN  A   192.168.46.158</a>
<a class="sourceLine" id="cb8-24" data-line-number="24"></a>
<a class="sourceLine" id="cb8-25" data-line-number="25">;; Query time: 0 msec</a>
<a class="sourceLine" id="cb8-26" data-line-number="26">;; SERVER: 127.0.0.1#53(127.0.0.1)</a>
<a class="sourceLine" id="cb8-27" data-line-number="27">;; WHEN: Sun Feb 18 21:05:05 CST 2018</a>
<a class="sourceLine" id="cb8-28" data-line-number="28">;; MSG SIZE  rcvd: 132</a></code></pre></div>
<h2 id="client主机测试">client主机测试</h2>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="co"># 修改客户端的dns指向为我们自己的dns主机</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">[<span class="ex">root@centos-159</span> ~]# nmcli con modify  ens33 ipv4.dns 192.168.46.158</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="co"># 重启网络，或者重新加载</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4">[<span class="ex">root@centos-159</span> ~]# service network restart</a>
<a class="sourceLine" id="cb9-5" data-line-number="5"></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="co"># ping下我们的web主机，看是否能解析出来157，156两个ip</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7">[<span class="ex">root@centos-159</span> ~]# ping www.linuxpanda.tech</a>
<a class="sourceLine" id="cb9-8" data-line-number="8"><span class="ex">PING</span> web.linuxpanda.tech (192.168.46.157) <span class="ex">56</span>(84) <span class="ex">bytes</span> of data.</a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="ex">64</span> bytes from 192.168.46.157 (192.168.46.157)<span class="bu">:</span> icmp_seq=1 ttl=64 time=0.330 ms</a>
<a class="sourceLine" id="cb9-10" data-line-number="10"><span class="ex">64</span> bytes from 192.168.46.157 (192.168.46.157)<span class="bu">:</span> icmp_seq=2 ttl=64 time=0.255 ms</a>
<a class="sourceLine" id="cb9-11" data-line-number="11"><span class="ex">64</span> bytes from 192.168.46.157 (192.168.46.157)<span class="bu">:</span> icmp_seq=3 ttl=64 time=0.292 ms</a>
<a class="sourceLine" id="cb9-12" data-line-number="12"></a>
<a class="sourceLine" id="cb9-13" data-line-number="13">[<span class="ex">root@centos-159</span> ~]# ping www.linuxpanda.tech</a>
<a class="sourceLine" id="cb9-14" data-line-number="14"><span class="ex">PING</span> web.linuxpanda.tech (192.168.46.156) <span class="ex">56</span>(84) <span class="ex">bytes</span> of data.</a>
<a class="sourceLine" id="cb9-15" data-line-number="15"><span class="ex">64</span> bytes from 192.168.46.156 (192.168.46.156)<span class="bu">:</span> icmp_seq=1 ttl=64 time=0.421 ms</a></code></pre></div>
<div class="note">
<div class="admonition-title">
<p>Note</p>
</div>
<p>ping命令去测试有点不专业的，需要多次测试才能2个地址都出现，这里就不安装dig工具了，毕竟客户端。</p>
</div>
<h2 id="nfs主机配置">nfs主机配置</h2>
<h3 id="添加用户">添加用户</h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb10-1" data-line-number="1">[<span class="ex">root@centos-154</span> ~]# groupadd -g 48 apache</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">[<span class="ex">root@centos-154</span> ~]# useradd -u 48 -g 48 apache</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">[<span class="ex">root@centos-154</span> ~]# id apache</a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="va">uid=</span>48<span class="va">(</span>apache<span class="va">)</span> <span class="va">gid=</span>48<span class="va">(</span>apache<span class="va">)</span> <span class="va">groups=</span>48<span class="va">(</span>apache<span class="va">)</span></a></code></pre></div>
<h3 id="修改权限">修改权限</h3>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb11-1" data-line-number="1">[<span class="ex">root@centos-154</span> ~]# chown -R apache.apache /data/html</a></code></pre></div>
<h3 id="共享出去">共享出去</h3>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb12-1" data-line-number="1">[<span class="ex">root@centos-154</span> ~]# yum install nfs-utils</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">[<span class="ex">root@centos-154</span> ~]# vim /etc/exports</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">[<span class="ex">root@centos-154</span> ~]# cat /etc/exports</a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="ex">/data/html</span> 192.168.46.156(rw,all_squash,anonuid=apache,anongid=apache)</a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="ex">/data/html</span> 192.168.46.156(rw,all_squash,anonuid=apache,anongid=apache)</a>
<a class="sourceLine" id="cb12-6" data-line-number="6">[<span class="ex">root@centos-154</span> ~]# systemctl restart nfsd</a>
<a class="sourceLine" id="cb12-7" data-line-number="7">[<span class="ex">root@centos-154</span> ~]# exportfs -v </a>
<a class="sourceLine" id="cb12-8" data-line-number="8"><span class="ex">/data/html</span>      192.168.46.156(rw,sync,wdelay,hide,no_subtree_check,anonuid=48,anongid=48,sec=sys,secure,root_squash,all_squash)</a>
<a class="sourceLine" id="cb12-9" data-line-number="9"><span class="ex">/data/html</span>      192.168.46.157(rw,sync,wdelay,hide,no_subtree_check,anonuid=48,anongid=48,sec=sys,secure,root_squash,all_squash)</a></code></pre></div>
<h2 id="mysql主机配置">mysql主机配置</h2>
<h3 id="安装软件">安装软件</h3>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb13-1" data-line-number="1">[<span class="ex">root@centos-155</span> ~]# yum install mariadb-server mariadb</a></code></pre></div>
<h3 id="启动服务">启动服务</h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb14-1" data-line-number="1">[<span class="ex">root@centos-155</span> ~]# systemctl start mariadb</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">[<span class="ex">root@centos-155</span> ~]# netstat -tunlp <span class="kw">|</span><span class="fu">grep</span> 3306</a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="ex">tcp</span>        0      0 0.0.0.0:3306            0.0.0.0:*               LISTEN      13680/mysqld </a></code></pre></div>
<h3 id="添加应用用户">添加应用用户</h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb15-1" data-line-number="1">[root@centos<span class="dv">-155</span> ~]# mysql -u root -p </a>
<a class="sourceLine" id="cb15-2" data-line-number="2">Enter password: </a>
<a class="sourceLine" id="cb15-3" data-line-number="3">Welcome <span class="kw">to</span> <span class="kw">the</span> MariaDB monitor.  Commands <span class="kw">end</span> <span class="kw">with</span> ; <span class="kw">or</span> \g.</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">Your MariaDB connection <span class="kw">id</span> <span class="kw">is</span> <span class="dv">10</span></a>
<a class="sourceLine" id="cb15-5" data-line-number="5">Server version: <span class="dv">5</span>.<span class="fl">5.56</span>-MariaDB MariaDB Server</a>
<a class="sourceLine" id="cb15-6" data-line-number="6"></a>
<a class="sourceLine" id="cb15-7" data-line-number="7">Copyright (c) <span class="dv">2000</span>, <span class="dv">2017</span>, Oracle, MariaDB Corporation Ab <span class="kw">and</span> others.</a>
<a class="sourceLine" id="cb15-8" data-line-number="8"></a>
<a class="sourceLine" id="cb15-9" data-line-number="9"><span class="kw">Type</span> <span class="st">&#39;help;&#39;</span> <span class="kw">or</span> <span class="st">&#39;\h&#39;</span> <span class="kw">for</span> help. <span class="kw">Type</span> <span class="st">&#39;\c&#39;</span> <span class="kw">to</span> <span class="kw">clear</span> <span class="kw">the</span> <span class="kw">current</span> input statement.</a>
<a class="sourceLine" id="cb15-10" data-line-number="10"></a>
<a class="sourceLine" id="cb15-11" data-line-number="11">MariaDB [(<span class="kw">none</span>)]&gt; <span class="kw">create</span> <span class="kw">database</span> web ;</a>
<a class="sourceLine" id="cb15-12" data-line-number="12"><span class="kw">Query</span> OK, <span class="dv">1</span> <span class="kw">row</span> affected (<span class="fl">0.00</span> sec)</a>
<a class="sourceLine" id="cb15-13" data-line-number="13"></a>
<a class="sourceLine" id="cb15-14" data-line-number="14">MariaDB [(<span class="kw">none</span>)]&gt; <span class="kw">grant</span> <span class="kw">all</span> <span class="kw">on</span> web.* <span class="kw">to</span> web@<span class="st">&#39;192.168.46.%&#39;</span> <span class="kw">identified</span> <span class="kw">by</span> <span class="st">&#39;oracle&#39;</span>;</a>
<a class="sourceLine" id="cb15-15" data-line-number="15"><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.05</span> sec)</a></code></pre></div>
<h3 id="安全初始化">安全初始化</h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb16-1" data-line-number="1">[<span class="ex">root@centos-155</span> ~]# mysql_secure_installation </a></code></pre></div>
<h2 id="web主机配置">web主机配置</h2>
<p>这里是2个主机。</p>
<h3 id="安装软件-1">安装软件</h3>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="co"># 安装</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2">[<span class="ex">root@centos-150</span> ~]# ansible web -m yum -a <span class="st">&#39;name=httpd,php-fpm,php-mysql,mod_fcgid state=installed&#39;</span></a>
<a class="sourceLine" id="cb17-3" data-line-number="3"><span class="co"># 启动服务</span></a>
<a class="sourceLine" id="cb17-4" data-line-number="4">[<span class="ex">root@centos-150</span> ~]# ansible web -m service -a <span class="st">&#39;name=httpd state=started&#39;</span></a>
<a class="sourceLine" id="cb17-5" data-line-number="5">[<span class="ex">root@centos-150</span> ~]# ansible web -m service -a <span class="st">&#39;name=php-fpm state=started&#39;</span></a></code></pre></div>
<h3 id="挂载目录">挂载目录</h3>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="co"># 安装必要的挂载相关的软件</span></a>
<a class="sourceLine" id="cb18-2" data-line-number="2">[<span class="ex">root@centos-156</span> httpd]# yum install nfs-utils cifs-utils</a>
<a class="sourceLine" id="cb18-3" data-line-number="3"><span class="co"># 启动rpc服务</span></a>
<a class="sourceLine" id="cb18-4" data-line-number="4">[<span class="ex">root@centos-156</span> httpd]# systemctl restart rpcbind</a>
<a class="sourceLine" id="cb18-5" data-line-number="5"><span class="co"># 查看远程的导出情况</span></a>
<a class="sourceLine" id="cb18-6" data-line-number="6">[<span class="ex">root@centos-156</span> httpd]# showmount -e 192.168.46.154</a>
<a class="sourceLine" id="cb18-7" data-line-number="7"><span class="ex">Export</span> list for 192.168.46.154:</a>
<a class="sourceLine" id="cb18-8" data-line-number="8"><span class="ex">/data/html</span> 192.168.46.157,192.168.46.156</a>
<a class="sourceLine" id="cb18-9" data-line-number="9"><span class="co"># 挂载</span></a>
<a class="sourceLine" id="cb18-10" data-line-number="10">[<span class="ex">root@centos-156</span> httpd]# mount 192.168.46.154:/data/html /var/www/html</a>
<a class="sourceLine" id="cb18-11" data-line-number="11"></a>
<a class="sourceLine" id="cb18-12" data-line-number="12"><span class="co"># 自动挂载</span></a>
<a class="sourceLine" id="cb18-13" data-line-number="13">[<span class="ex">root@centos-156</span> httpd]# tail -n 1 /etc/mtab</a>
<a class="sourceLine" id="cb18-14" data-line-number="14"><span class="ex">192.168.46.154</span>:/data/html /var/www/html nfs4 rw,relatime,vers=4.1,rsize=65536,wsize=65536,namlen=255,hard,proto=tcp,port=0,timeo=600,retrans=2,sec=sys,clientaddr=192.168.46.156,local_lock=none,addr=192.168.46.154 0 0</a>
<a class="sourceLine" id="cb18-15" data-line-number="15">[<span class="ex">root@centos-156</span> httpd]# tail -n 1 /etc/mtab <span class="op">&gt;&gt;</span> /etc/fstab</a>
<a class="sourceLine" id="cb18-16" data-line-number="16"><span class="co"># 查看下样例网页</span></a>
<a class="sourceLine" id="cb18-17" data-line-number="17">[<span class="ex">root@centos-156</span> httpd]# cat /var/www/html/index.html </a>
<a class="sourceLine" id="cb18-18" data-line-number="18"><span class="ex">hellow</span> world</a></code></pre></div>
<h3 id="配置httpd">配置httpd</h3>
<p>本部分内容需要在2个机器都要做一遍。</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="co"># 下载一个样例的php页面  </span></a>
<a class="sourceLine" id="cb19-2" data-line-number="2">[<span class="ex">root@centos-156</span> httpd]# wget download.linuxpanda.tech/lamp/index.php.sample -O /var/www/html/index.php</a>
<a class="sourceLine" id="cb19-3" data-line-number="3"><span class="co"># 编辑下样例php页面的数据库连接用户和密码</span></a>
<a class="sourceLine" id="cb19-4" data-line-number="4">[<span class="ex">root@centos-156</span> httpd]# vim /var/www/html/index.php</a>
<a class="sourceLine" id="cb19-5" data-line-number="5">[<span class="ex">root@centos-156</span> httpd]# cat /var/www/html/index.php </a>
<a class="sourceLine" id="cb19-6" data-line-number="6"><span class="op">&lt;</span><span class="ex">?php</span></a>
<a class="sourceLine" id="cb19-7" data-line-number="7"><span class="va">$mysqli</span>=<span class="ex">new</span> mysqli(<span class="st">&quot;192.168.46.155&quot;</span>,<span class="st">&quot;web&quot;</span>,<span class="st">&quot;oracle&quot;</span>);</a>
<a class="sourceLine" id="cb19-8" data-line-number="8"><span class="ex">if</span>(mysqli_connect_errno())<span class="kw">{</span></a>
<a class="sourceLine" id="cb19-9" data-line-number="9"><span class="bu">echo</span> <span class="st">&quot;失败了&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb19-10" data-line-number="10"><span class="va">$mysqli</span>=<span class="ex">null</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb19-11" data-line-number="11"><span class="bu">exit</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb19-12" data-line-number="12"><span class="kw">}</span></a>
<a class="sourceLine" id="cb19-13" data-line-number="13"><span class="bu">echo</span> <span class="st">&quot;成功了&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb19-14" data-line-number="14"><span class="va">$mysqli</span><span class="ex">-</span><span class="op">&gt;</span>close();</a>
<a class="sourceLine" id="cb19-15" data-line-number="15"><span class="ex">?</span><span class="op">&gt;</span></a>
<a class="sourceLine" id="cb19-16" data-line-number="16"></a>
<a class="sourceLine" id="cb19-17" data-line-number="17"><span class="co"># fcgi编辑</span></a>
<a class="sourceLine" id="cb19-18" data-line-number="18">[<span class="ex">root@centos-156</span> conf.d]# vim fcgid.conf </a>
<a class="sourceLine" id="cb19-19" data-line-number="19"><span class="co"># 添加如下3行</span></a>
<a class="sourceLine" id="cb19-20" data-line-number="20"><span class="ex">DirectoryIndex</span> index.php</a>
<a class="sourceLine" id="cb19-21" data-line-number="21"><span class="ex">ProxyRequests</span> Off</a>
<a class="sourceLine" id="cb19-22" data-line-number="22"><span class="ex">ProxyPassMatch</span> ^/(.*\.php)$ <span class="ex">fcgi</span>://127.0.0.1:9000/var/www/html/<span class="va">$1</span></a>
<a class="sourceLine" id="cb19-23" data-line-number="23"><span class="co"># 重启网络服务</span></a>
<a class="sourceLine" id="cb19-24" data-line-number="24">[<span class="ex">root@centos-156</span> conf.d]# service httpd restart</a></code></pre></div>
<h3 id="本机测试">本机测试</h3>
<p>本部分内容需要在2个机器都要做一遍。</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb20-1" data-line-number="1">[<span class="ex">root@centos-156</span> conf.d]# curl localhost/index.php</a>
<a class="sourceLine" id="cb20-2" data-line-number="2">成功了</a></code></pre></div>
<h2 id="client测试">client测试</h2>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb21-1" data-line-number="1">[<span class="ex">root@centos-159</span> ~]# curl http://www.linuxpanda.tech/index.php</a>
<a class="sourceLine" id="cb21-2" data-line-number="2">成功了</a>
<a class="sourceLine" id="cb21-3" data-line-number="3"><span class="co"># 把156的web停掉</span></a>
<a class="sourceLine" id="cb21-4" data-line-number="4">[<span class="ex">root@centos-159</span> ~]# curl http://www.linuxpanda.tech/index.php</a>
<a class="sourceLine" id="cb21-5" data-line-number="5">成功了</a>
<a class="sourceLine" id="cb21-6" data-line-number="6"><span class="co"># 再把157的web停掉</span></a>
<a class="sourceLine" id="cb21-7" data-line-number="7">[<span class="ex">root@centos-159</span> ~]# curl http://www.linuxpanda.tech/index.php</a>
<a class="sourceLine" id="cb21-8" data-line-number="8"><span class="ex">curl</span>: (7) <span class="ex">Failed</span> connect to www.linuxpanda.tech:80<span class="kw">;</span> <span class="ex">Connection</span> refused</a></code></pre></div>
<h2 id="总结">总结</h2>
<p>这个作业，看起来挺简单的，做起来还是遇到些麻烦的。</p>
<p>需要改进的地方：</p>
<ol>
<li>dns解析太不稳定，如果web1停掉，dns还可能解析到这个停掉的主机，就会导致web没法访问。</li>
<li>mysql实例后面学习了主从可以考虑完善下。</li>
<li>lamp没有使用xcache加速下</li>
<li>本练习都是使用的yum安装的lamp环境，可以考虑使用编译安装方法。</li>
<li>数据通过nfs共享，本质还是一个磁盘的数据，可以考虑使用rsync来替代nfs。</li>
<li>数据文件可以考虑放到raid上，来提供文件的访问性能</li>
</ol>
<h2 id="参考">参考</h2>
<p><a href="http://linux.linuxpanda.tech/" target="_blank" rel="noopener">我自己在马哥教育笔记1</a></p>
<p><a href="http://services.linuxpanda.tech/" target="_blank" rel="noopener">我自己在马哥教育笔记2</a></p>
]]></content>
      
        <categories>
            
            <category> linux </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[使用七牛云存储提供一个数据分发服务]]></title>
      <url>/2018/02/16/%E4%BD%BF%E7%94%A8%E4%B8%83%E7%89%9B%E4%BA%91%E5%AD%98%E5%82%A8%E6%8F%90%E4%BE%9B%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%88%86%E5%8F%91%E6%9C%8D%E5%8A%A1/</url>
      <content type="html"><![CDATA[<h2 id="背景描述">背景描述</h2>
<p>我个人在阿里云注册一个域名和购买了一个主机，平时整理写脚本和一些压缩包，放在自己的download目录，然后使用apache配合虚拟主机 共享出来，但是遇到问题了， 我自己的阿里云主机的带宽是1M的，下载速度真的慢，想想可以使用七牛云存储来改进下我的下载速度问题， 把我的改进过程给大家分享下。</p>
<h2 id="七牛云简介">七牛云简介</h2>
<p>（七牛云）隶属于上海七牛信息技术有限公司，七牛云是国内领先的企业级云服务商，专注于以数据管理为中心的云计算业务研发和运营，围绕富媒体 场景推出了对象存储、融合 CDN 加速、容器计算云、大数据平台、人工智能平台等产品，并提供一站式视频云解决方案。公司目前已位列国内云计算 行业第一阵营，为 70 多万家企业提供服务。</p>
<h2 id="七牛云相关">七牛云相关</h2>
<h3 id="账号注册">账号注册</h3>
<p><a href="https://portal.qiniu.com/signup/choice" target="_blank" rel="noopener">注册地址</a></p>
<h3 id="账号实名认证">账号实名认证</h3>
<p>注册完毕需要下实名认证，很快的，大概1-2天就实名认证完毕了。</p>
<h3 id="新建存储空间">新建存储空间</h3>
<p><img src="/images/qiniu/新建存储.png" alt="image"></p>
<h3 id="绑定域名">绑定域名</h3>
<p><img src="/images/qiniu/绑定域名.png" alt="image"></p>
<h3 id="设置默认域名连接">设置默认域名连接</h3>
<p><img src="/images/qiniu/设置默认域名.png" alt="image"></p>
<h3 id="查看cname">查看cname</h3>
<p><img src="/images/qiniu/查看cname.png" alt="image"></p>
<h3 id="设置cname">设置cname</h3>
<p><img src="/images/qiniu/添加cname.png" alt="image"></p>
<p>这个需要在自己的域名解析里面添加下这个cname的记录项。</p>
<h3 id="key的获取">key的获取</h3>
<p><img src="/images/qiniu/七牛云key.png" alt="image"></p>
<h2 id="python3的安装可选">python3的安装(可选)</h2>
<p><a href="https://repo.continuum.io/archive/Anaconda3-5.1.0-Linux-x86_64.sh" target="_blank" rel="noopener">python的安装</a></p>
<p>这是一个bash脚本，下载下载下来运行就可以，注意设置下安装路径，我设置的是/usr/loca/python3</p>
<h2 id="安装七牛云的python包">安装七牛云的python包</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1">[<span class="ex">root@www</span> qiniu]# /usr/local/python3/bin/pip install qiniu</a></code></pre></div>
<p>安装完毕之后，我们就可以使用七牛云提供的pythonapi了。</p>
<h2 id="上传文件">上传文件</h2>
<h3 id="编辑config文件">编辑config文件</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" data-line-number="1">[<span class="ex">root@www</span> qiniu]# vim /usr/local/python3/lib/python3.6/site-packages/qiniu/config.py</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="co"># 修改超时时间</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="st">&#39;connection_timeout&#39;</span>: <span class="ex">300000</span>,        # 链接超时为时间为30s</a></code></pre></div>
<p>因为我们自己上传的文件，可能很大，就会导致因链接时间过短而导致的上传失败，需要调整下timeout就可以了。</p>
<h3 id="编写脚本">编写脚本</h3>
<p><a href="https://developer.qiniu.com/kodo/sdk/1242/python#upload-flow" target="_blank" rel="noopener">官方api</a></p>
<p>结合官方的api，我自己修改了下，如下。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co"># -*- coding: utf-8 -*-</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="co"># flake8: noqa</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="im">from</span> qiniu <span class="im">import</span> Auth, put_file, etag, urlsafe_base64_encode</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="im">import</span> qiniu.config</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="im">import</span> os</a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="im">import</span> glob</a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="im">import</span> json</a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="im">import</span> jmespath</a>
<a class="sourceLine" id="cb3-9" data-line-number="9">hash_json_file <span class="op">=</span> <span class="st">&quot;/root/bin/hash_file.json&quot;</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10">hash_json <span class="op">=</span> []</a>
<a class="sourceLine" id="cb3-11" data-line-number="11">hash_value <span class="op">=</span> []</a>
<a class="sourceLine" id="cb3-12" data-line-number="12">need_add <span class="op">=</span> []</a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="cf">if</span> os.path.exists(hash_json_file):</a>
<a class="sourceLine" id="cb3-14" data-line-number="14">        <span class="cf">with</span> <span class="bu">open</span>(hash_json_file) <span class="im">as</span> f:</a>
<a class="sourceLine" id="cb3-15" data-line-number="15">                hash_json<span class="op">=</span>json.load(f)</a>
<a class="sourceLine" id="cb3-16" data-line-number="16">                hash_value<span class="op">=</span>jmespath.search(<span class="st">&#39;[*].hash&#39;</span>,hash_json)</a>
<a class="sourceLine" id="cb3-17" data-line-number="17"><span class="co">#print(hash_json)</span></a>
<a class="sourceLine" id="cb3-18" data-line-number="18"><span class="co">#需要填写你的 Access Key 和 Secret Key</span></a>
<a class="sourceLine" id="cb3-19" data-line-number="19">access_key <span class="op">=</span> <span class="st">&#39;6VGRI141Y1IHzO0WyIu9NKuKCPAMZsECmV80-sK0&#39;</span></a>
<a class="sourceLine" id="cb3-20" data-line-number="20">secret_key <span class="op">=</span> <span class="st">&#39;1GQwv1f8qcIQn3o9Bq3_1xXP_JR_-GQPlZDfK7pu&#39;</span></a>
<a class="sourceLine" id="cb3-21" data-line-number="21"><span class="co">#构建鉴权对象</span></a>
<a class="sourceLine" id="cb3-22" data-line-number="22">q <span class="op">=</span> Auth(access_key, secret_key)</a>
<a class="sourceLine" id="cb3-23" data-line-number="23"><span class="co">#要上传的空间</span></a>
<a class="sourceLine" id="cb3-24" data-line-number="24">bucket_name <span class="op">=</span> <span class="st">&#39;download&#39;</span></a>
<a class="sourceLine" id="cb3-25" data-line-number="25">tmpfiles<span class="op">=</span>glob.glob(<span class="st">&quot;/git/download/**/*&quot;</span> ,recursive<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb3-26" data-line-number="26">files<span class="op">=</span>[x <span class="cf">for</span> x <span class="kw">in</span> tmpfiles <span class="cf">if</span> os.path.isfile(x)]</a>
<a class="sourceLine" id="cb3-27" data-line-number="27"><span class="cf">for</span> file_item <span class="kw">in</span> files:</a>
<a class="sourceLine" id="cb3-28" data-line-number="28">        <span class="bu">print</span>(<span class="st">&quot;=================&gt;start upload&quot;</span> <span class="op">+</span> file_item)</a>
<a class="sourceLine" id="cb3-29" data-line-number="29">        <span class="co">#要上传文件的本地路径</span></a>
<a class="sourceLine" id="cb3-30" data-line-number="30">        localfile <span class="op">=</span> file_item</a>
<a class="sourceLine" id="cb3-31" data-line-number="31">        tmp_hash <span class="op">=</span> etag(localfile)</a>
<a class="sourceLine" id="cb3-32" data-line-number="32">        <span class="cf">if</span> <span class="bu">len</span>(hash_value) <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span>  tmp_hash <span class="kw">in</span> hash_value:</a>
<a class="sourceLine" id="cb3-33" data-line-number="33">                <span class="bu">print</span>(<span class="st">&quot;========&gt;sikp&quot;</span> <span class="op">+</span> localfile)</a>
<a class="sourceLine" id="cb3-34" data-line-number="34">                <span class="cf">continue</span></a>
<a class="sourceLine" id="cb3-35" data-line-number="35">        <span class="co">#上传到七牛后保存的文件名</span></a>
<a class="sourceLine" id="cb3-36" data-line-number="36">        key <span class="op">=</span> file_item.replace(<span class="st">&quot;/git/download/&quot;</span>,<span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb3-37" data-line-number="37">        <span class="co">#生成上传 Token，可以指定过期时间等</span></a>
<a class="sourceLine" id="cb3-38" data-line-number="38">        token <span class="op">=</span> q.upload_token(bucket_name, key, <span class="dv">3600</span>)</a>
<a class="sourceLine" id="cb3-39" data-line-number="39">        ret, info <span class="op">=</span> put_file(token, key, localfile)</a>
<a class="sourceLine" id="cb3-40" data-line-number="40">        <span class="bu">print</span>(ret)</a>
<a class="sourceLine" id="cb3-41" data-line-number="41">        <span class="co">#print(info)</span></a>
<a class="sourceLine" id="cb3-42" data-line-number="42">        need_add.append(ret)</a>
<a class="sourceLine" id="cb3-43" data-line-number="43">        <span class="co">#assert ret[&#39;key&#39;] == key</span></a>
<a class="sourceLine" id="cb3-44" data-line-number="44">        <span class="co">#assert ret[&#39;hash&#39;] == etag(localfile)</span></a>
<a class="sourceLine" id="cb3-45" data-line-number="45"></a>
<a class="sourceLine" id="cb3-46" data-line-number="46">hash_json<span class="op">+=</span>need_add</a>
<a class="sourceLine" id="cb3-47" data-line-number="47"><span class="bu">print</span>(<span class="st">&quot;=&quot;</span><span class="op">*</span><span class="dv">20</span>)</a>
<a class="sourceLine" id="cb3-48" data-line-number="48"><span class="bu">print</span>(json.dumps(need_add, indent<span class="op">=</span><span class="dv">4</span>))</a>
<a class="sourceLine" id="cb3-49" data-line-number="49"><span class="bu">print</span>(<span class="st">&quot;=&quot;</span><span class="op">*</span><span class="dv">20</span>)</a>
<a class="sourceLine" id="cb3-50" data-line-number="50"><span class="cf">with</span> <span class="bu">open</span>(hash_json_file,<span class="st">&#39;w&#39;</span>,encoding<span class="op">=</span><span class="st">&#39;utf-8&#39;</span>) <span class="im">as</span> f:</a>
<a class="sourceLine" id="cb3-51" data-line-number="51">        json.dump(hash_json,f,indent<span class="op">=</span><span class="dv">4</span>)</a></code></pre></div>
<p>代码也是比较简单，就是利用了一个hash文件来控制不去上传重复的文件。</p>
<h3 id="测试上传">测试上传</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" data-line-number="1">[<span class="ex">root@www</span> bin]# /usr/local/python3/bin/python /root/bin/push_download_to_qiniu.py </a></code></pre></div>
<h3 id="配置计划任务">配置计划任务</h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" data-line-number="1">[<span class="ex">root@www</span> bin]# crontab -e</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="co"># 添加如下行</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="ex">1</span> 1 * * * /usr/local/python3/bin/python /root/bin/push_download_to_qiniu.py</a></code></pre></div>
<h3 id="测试下载速度">测试下载速度</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="ex">C</span>:\Users\Administrator<span class="op">&gt;</span>curl http://download.linuxpanda.tech/lamp/mariadb-10.2.12.tar.gz?attname= -O</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">  <span class="ex">%</span> Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">                                <span class="ex">Dload</span>  Upload   Total   Spent    Left  Speed</a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="ex">100</span> 69.4M  100 69.4M    0     0  3555k      0  0:00:20  0:00:20 --:--:-- 5151k</a></code></pre></div>
<p>一个近60M的文件20秒就下载完毕了，平均1s就3M,下载速度杠杠滴，要是使用我自己的那个1M的带宽，那个下载速度最大也就125k。</p>
<h3 id="配置自己的下载地址">配置自己的下载地址</h3>
<p>上面使用了七牛云的下载地址，但是没有列表展示界面，很不爽啊， 我还是希望我可以 能看到我自己的列表信息，可以在apache上配置一个虚拟主机。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode xml"><code class="sourceCode xml"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">&lt;VirtualHost</span> <span class="er">*:80</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">  ServerName download2.linuxpanda.tech</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">  ServerAlias down2.linuxpanda.tech ftp2.linuxpanda.tech</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">  DocumentRoot /git/download</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">  <span class="kw">&lt;Directory</span> <span class="er">/git/download</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6">        Options  +FollowSymLinks</a>
<a class="sourceLine" id="cb7-7" data-line-number="7">        AllowOverride All</a>
<a class="sourceLine" id="cb7-8" data-line-number="8">        Require all granted</a>
<a class="sourceLine" id="cb7-9" data-line-number="9">  <span class="kw">&lt;/Directory&gt;</span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10"><span class="kw">&lt;/VirtualHost&gt;</span></a></code></pre></div>
<p>访问的自己的输入对应的地址： <a href="http://download2.linuxpanda.tech" target="_blank" rel="noopener">download2.linuxpanda.tech</a></p>
]]></content>
      
        <categories>
            
            <category> linux </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[CA服务器的搭建]]></title>
      <url>/2018/02/13/CA%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E6%90%AD%E5%BB%BA/</url>
      <content type="html"><![CDATA[<p><a href="http://www.cnblogs.com/zhaojiedi1992/p/zhaojiedi_linux_011_ca.html" target="_blank" rel="noopener">另一篇关于ca的文章</a></p>
<h2 id="ca服务器的配置">CA服务器的配置</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1">[<span class="ex">root@localhost</span> CA]# cd /etc/pki/CA/</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1-3" data-line-number="3">[<span class="ex">root@localhost</span> CA]# sed -r  -i <span class="st">&#39;s@#?countryName_default.*@countryName_default=cn@&#39;</span> /etc/pki/tls/openssl.cnf</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">[<span class="ex">root@localhost</span> CA]# sed -r  -i <span class="st">&#39;s@#?stateOrProvinceName_default.*@stateOrProvinceName_default=henan@&#39;</span> /etc/pki/tls/openssl.cnf</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">[<span class="ex">root@localhost</span> CA]# sed -r  -i <span class="st">&#39;s@#?localityName_default.*@localityName_default=zhengzhou@&#39;</span> /etc/pki/tls/openssl.cnf</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">[<span class="ex">root@localhost</span> CA]# sed -r  -i <span class="st">&#39;s@#?0.organizationName_default.*@0.organizationName_default=linuxpanda@&#39;</span> /etc/pki/tls/openssl.cnf</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">[<span class="ex">root@localhost</span> CA]# sed -r  -i <span class="st">&#39;s@#?organizationalUnitName_default.*@organizationalUnitName_default=opt@&#39;</span> /etc/pki/tls/openssl.cnf</a>
<a class="sourceLine" id="cb1-8" data-line-number="8"></a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="co"># 在CA目录创建一个Makefile</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10">[<span class="ex">root@localhost</span> CA]# wget http://download.linuxpanda.tech/ca/Makefile</a>
<a class="sourceLine" id="cb1-11" data-line-number="11"></a>
<a class="sourceLine" id="cb1-12" data-line-number="12"><span class="co"># 初始化创建文件</span></a>
<a class="sourceLine" id="cb1-13" data-line-number="13">[<span class="ex">root@localhost</span> CA]# make init</a>
<a class="sourceLine" id="cb1-14" data-line-number="14"><span class="co"># 创建ca私钥和对应的自签证书</span></a>
<a class="sourceLine" id="cb1-15" data-line-number="15">[<span class="ex">root@localhost</span> CA]# make ca</a>
<a class="sourceLine" id="cb1-16" data-line-number="16"><span class="bu">umask</span> 77 <span class="kw">;</span> <span class="kw">\</span></a>
<a class="sourceLine" id="cb1-17" data-line-number="17"><span class="ex">/usr/bin/openssl</span> genrsa -out private/cakey.pem 2048 <span class="kw">;</span> <span class="kw">\</span></a>
<a class="sourceLine" id="cb1-18" data-line-number="18"><span class="ex">/usr/bin/openssl</span> req -utf8 -new -x509 -key private/cakey.pem -out cacert.pem  -days 3650   <span class="kw">;</span> </a>
<a class="sourceLine" id="cb1-19" data-line-number="19"><span class="ex">Generating</span> RSA private key, 2048 bit long modulus</a>
<a class="sourceLine" id="cb1-20" data-line-number="20"><span class="ex">......................................................+++</span></a>
<a class="sourceLine" id="cb1-21" data-line-number="21"><span class="ex">............+++</span></a>
<a class="sourceLine" id="cb1-22" data-line-number="22"><span class="ex">e</span> is 65537 (0x10001)</a>
<a class="sourceLine" id="cb1-23" data-line-number="23"><span class="ex">You</span> are about to be asked to enter information that will be incorporated</a>
<a class="sourceLine" id="cb1-24" data-line-number="24"><span class="ex">into</span> your certificate request.</a>
<a class="sourceLine" id="cb1-25" data-line-number="25"><span class="ex">What</span> you are about to enter is what is called a Distinguished Name or a DN.</a>
<a class="sourceLine" id="cb1-26" data-line-number="26"><span class="ex">There</span> are quite a few fields but you can leave some blank</a>
<a class="sourceLine" id="cb1-27" data-line-number="27"><span class="ex">For</span> some fields there will be a default value,</a>
<a class="sourceLine" id="cb1-28" data-line-number="28"><span class="ex">If</span> you enter <span class="st">&#39;.&#39;</span>, the field will be left blank.</a>
<a class="sourceLine" id="cb1-29" data-line-number="29"><span class="ex">-----</span></a>
<a class="sourceLine" id="cb1-30" data-line-number="30"><span class="ex">Country</span> Name (2 letter code) [<span class="ex">cn</span>]:</a>
<a class="sourceLine" id="cb1-31" data-line-number="31"><span class="ex">State</span> or Province Name (full name) [<span class="ex">henan</span>]:</a>
<a class="sourceLine" id="cb1-32" data-line-number="32"><span class="ex">Locality</span> Name (eg, city) [<span class="ex">zhengzhou</span>]:</a>
<a class="sourceLine" id="cb1-33" data-line-number="33"><span class="ex">Organization</span> Name (eg, company) [<span class="ex">linuxpanda</span>]:</a>
<a class="sourceLine" id="cb1-34" data-line-number="34"><span class="ex">Organizational</span> Unit Name (eg, section) [<span class="ex">opt</span>]:</a>
<a class="sourceLine" id="cb1-35" data-line-number="35"><span class="ex">Common</span> Name (eg, your name or your server<span class="st">&#39;s hostname) []:ca.linuxpanda.tech</span></a>
<a class="sourceLine" id="cb1-36" data-line-number="36"><span class="st">Email Address []:</span></a></code></pre></div>
<h2 id="客户端的配置">客户端的配置</h2>
<p>这里使用为http配置为例,同样需要那个Makedown文件</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" data-line-number="1">[<span class="ex">root@localhost</span> CA]# wget http://download.linuxpanda.tech/ca/Makefile</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="co"># 先获取make的帮助使用</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4">[<span class="ex">root@localhost</span> CA]# make usage</a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="ex">This</span> makefile allows you to create:</a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="fu">make</span> init</a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="fu">make</span> ca</a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="fu">make</span> /etc/httpd/ssl/http.key</a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="fu">make</span> /etc/httpd/ssl/httpd.csr</a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="fu">make</span> copytoca csr=httpd.csr</a>
<a class="sourceLine" id="cb2-11" data-line-number="11"><span class="fu">make</span> copytoclient crt=httpd.crt ip=192.168.46.1</a>
<a class="sourceLine" id="cb2-12" data-line-number="12"><span class="fu">make</span> httpd.csr</a>
<a class="sourceLine" id="cb2-13" data-line-number="13"><span class="fu">make</span> revoke crt=httpd</a>
<a class="sourceLine" id="cb2-14" data-line-number="14"></a>
<a class="sourceLine" id="cb2-15" data-line-number="15">[<span class="ex">root@localhost</span> CA]# yum install httpd -y </a>
<a class="sourceLine" id="cb2-16" data-line-number="16">[<span class="ex">root@localhost</span> CA]# mkdir /etc/httpd/ssl</a>
<a class="sourceLine" id="cb2-17" data-line-number="17">[<span class="ex">root@localhost</span> CA]# make /etc/httpd/ssl/httpd.key</a>
<a class="sourceLine" id="cb2-18" data-line-number="18"><span class="bu">umask</span> 77 <span class="kw">;</span> <span class="kw">\</span></a>
<a class="sourceLine" id="cb2-19" data-line-number="19"><span class="ex">/usr/bin/openssl</span> genrsa  2048 <span class="op">&gt;</span> /etc/httpd/ssl/httpd.key</a>
<a class="sourceLine" id="cb2-20" data-line-number="20"><span class="ex">Generating</span> RSA private key, 2048 bit long modulus</a>
<a class="sourceLine" id="cb2-21" data-line-number="21"><span class="ex">...........+++</span></a>
<a class="sourceLine" id="cb2-22" data-line-number="22"><span class="ex">...............+++</span></a>
<a class="sourceLine" id="cb2-23" data-line-number="23"><span class="ex">e</span> is 65537 (0x10001)</a>
<a class="sourceLine" id="cb2-24" data-line-number="24">[<span class="ex">root@localhost</span> CA]# make /etc/httpd/ssl/httpd.csr</a>
<a class="sourceLine" id="cb2-25" data-line-number="25"><span class="bu">umask</span> 77 <span class="kw">;</span> <span class="kw">\</span></a>
<a class="sourceLine" id="cb2-26" data-line-number="26"><span class="ex">/usr/bin/openssl</span> req -utf8 -new -key /etc/httpd/ssl/httpd.key -out /etc/httpd/ssl/httpd.csr</a>
<a class="sourceLine" id="cb2-27" data-line-number="27"><span class="ex">You</span> are about to be asked to enter information that will be incorporated</a>
<a class="sourceLine" id="cb2-28" data-line-number="28"><span class="ex">into</span> your certificate request.</a>
<a class="sourceLine" id="cb2-29" data-line-number="29"><span class="ex">What</span> you are about to enter is what is called a Distinguished Name or a DN.</a>
<a class="sourceLine" id="cb2-30" data-line-number="30"><span class="ex">There</span> are quite a few fields but you can leave some blank</a>
<a class="sourceLine" id="cb2-31" data-line-number="31"><span class="ex">For</span> some fields there will be a default value,</a>
<a class="sourceLine" id="cb2-32" data-line-number="32"><span class="ex">If</span> you enter <span class="st">&#39;.&#39;</span>, the field will be left blank.</a>
<a class="sourceLine" id="cb2-33" data-line-number="33"><span class="ex">-----</span></a>
<a class="sourceLine" id="cb2-34" data-line-number="34"><span class="ex">Country</span> Name (2 letter code) [<span class="ex">cn</span>]:</a>
<a class="sourceLine" id="cb2-35" data-line-number="35"><span class="ex">State</span> or Province Name (full name) [<span class="ex">henan</span>]:</a>
<a class="sourceLine" id="cb2-36" data-line-number="36"><span class="ex">Locality</span> Name (eg, city) [<span class="ex">zhengzhou</span>]:</a>
<a class="sourceLine" id="cb2-37" data-line-number="37"><span class="ex">Organization</span> Name (eg, company) [<span class="ex">linuxpanda</span>]:</a>
<a class="sourceLine" id="cb2-38" data-line-number="38"><span class="ex">Organizational</span> Unit Name (eg, section) [<span class="ex">opt</span>]:</a>
<a class="sourceLine" id="cb2-39" data-line-number="39"><span class="ex">Common</span> Name (eg, your name or your server<span class="st">&#39;s hostname) []:www.linuxpanda.tech</span></a>
<a class="sourceLine" id="cb2-40" data-line-number="40"><span class="st">Email Address []:</span></a>
<a class="sourceLine" id="cb2-41" data-line-number="41"></a>
<a class="sourceLine" id="cb2-42" data-line-number="42"><span class="st">Please enter the following &#39;</span>extra<span class="st">&#39; attributes</span></a>
<a class="sourceLine" id="cb2-43" data-line-number="43"><span class="st">to be sent with your certificate request</span></a>
<a class="sourceLine" id="cb2-44" data-line-number="44"><span class="st">A challenge password []:</span></a>
<a class="sourceLine" id="cb2-45" data-line-number="45"><span class="st">An optional company name []:</span></a>
<a class="sourceLine" id="cb2-46" data-line-number="46"></a>
<a class="sourceLine" id="cb2-47" data-line-number="47"><span class="st">[root@localhost CA]# make copytoca crt=/etc/httpd/ssl/httpd.csr</span></a>
<a class="sourceLine" id="cb2-48" data-line-number="48"><span class="st">scp /etc/httpd/ssl/httpd.csr 192.168.46.129:/etc/pki/CA/csr/</span></a>
<a class="sourceLine" id="cb2-49" data-line-number="49"><span class="st">root@192.168.46.129&#39;</span>s password: </a>
<a class="sourceLine" id="cb2-50" data-line-number="50"><span class="ex">httpd.csr</span>                                                           100% 1017   319.1KB/s   00:00 </a></code></pre></div>
<h2 id="ca颁发证书">CA颁发证书</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" data-line-number="1">[<span class="ex">root@localhost</span> CA]# make httpd.crt</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="ex">/usr/bin/openssl</span> ca -utf8 -days 365 -in csr/httpd.csr -out certs/httpd.crt</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="ex">Using</span> configuration from /etc/pki/tls/openssl.cnf</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="ex">Check</span> that the request matches the signature</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="ex">Signature</span> ok</a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="ex">Certificate</span> Details:</a>
<a class="sourceLine" id="cb3-7" data-line-number="7">        <span class="ex">Serial</span> Number: 1 (0x1)</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">        <span class="ex">Validity</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9">            <span class="ex">Not</span> Before: Feb 13 04:49:57 2018 GMT</a>
<a class="sourceLine" id="cb3-10" data-line-number="10">            <span class="ex">Not</span> After : Feb 13 04:49:57 2019 GMT</a>
<a class="sourceLine" id="cb3-11" data-line-number="11">        <span class="ex">Subject</span>:</a>
<a class="sourceLine" id="cb3-12" data-line-number="12">            <span class="ex">countryName</span>               = cn</a>
<a class="sourceLine" id="cb3-13" data-line-number="13">            <span class="ex">stateOrProvinceName</span>       = henan</a>
<a class="sourceLine" id="cb3-14" data-line-number="14">            <span class="ex">organizationName</span>          = linuxpanda</a>
<a class="sourceLine" id="cb3-15" data-line-number="15">            <span class="ex">organizationalUnitName</span>    = opt</a>
<a class="sourceLine" id="cb3-16" data-line-number="16">            <span class="ex">commonName</span>                = www.linuxpanda.tech</a>
<a class="sourceLine" id="cb3-17" data-line-number="17">        <span class="ex">X509v3</span> extensions:</a>
<a class="sourceLine" id="cb3-18" data-line-number="18">            <span class="ex">X509v3</span> Basic Constraints: </a>
<a class="sourceLine" id="cb3-19" data-line-number="19">                <span class="ex">CA</span>:FALSE</a>
<a class="sourceLine" id="cb3-20" data-line-number="20">            <span class="ex">Netscape</span> Comment: </a>
<a class="sourceLine" id="cb3-21" data-line-number="21">                <span class="ex">OpenSSL</span> Generated Certificate</a>
<a class="sourceLine" id="cb3-22" data-line-number="22">            <span class="ex">X509v3</span> Subject Key Identifier: </a>
<a class="sourceLine" id="cb3-23" data-line-number="23">                <span class="ex">EE</span>:92:FF:A7:15:8F:39:DD:65:AC:B4:F1:59:76:04:32:18:9B:25:8E</a>
<a class="sourceLine" id="cb3-24" data-line-number="24">            <span class="ex">X509v3</span> Authority Key Identifier: </a>
<a class="sourceLine" id="cb3-25" data-line-number="25">                <span class="ex">keyid</span>:B0:9B:0B:62:50:40:E3:00:C6:4D:4F:3E:76:F9:E0:6F:A6:18:20:1C</a>
<a class="sourceLine" id="cb3-26" data-line-number="26"></a>
<a class="sourceLine" id="cb3-27" data-line-number="27"><span class="ex">Certificate</span> is to be certified until Feb 13 04:49:57 2019 GMT (365 days)</a>
<a class="sourceLine" id="cb3-28" data-line-number="28"><span class="ex">Sign</span> the certificate? [y/n]:y</a>
<a class="sourceLine" id="cb3-29" data-line-number="29"></a>
<a class="sourceLine" id="cb3-30" data-line-number="30"></a>
<a class="sourceLine" id="cb3-31" data-line-number="31"><span class="ex">1</span> out of 1 certificate requests certified, commit? [y/n]y</a>
<a class="sourceLine" id="cb3-32" data-line-number="32"><span class="ex">Write</span> out database with 1 new entries</a>
<a class="sourceLine" id="cb3-33" data-line-number="33"><span class="ex">Data</span> Base Updated</a>
<a class="sourceLine" id="cb3-34" data-line-number="34">[<span class="ex">root@localhost</span> CA]# make copytoclient crt=htttpd.crt ip=192.168.46.2</a></code></pre></div>
<h2 id="ca吊销证书">CA吊销证书</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" data-line-number="1">[<span class="ex">root@localhost</span> CA]# make showcrt crt=certs/httpd.crt </a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="ex">/usr/bin/openssl</span> x509  -in certs/httpd.crt -noout -serial -subject  </a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="va">serial=</span>01</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="va">subject=</span> /<span class="va">C=</span>cn/ST=<span class="ex">henan</span>/<span class="va">O=</span>linuxpanda/OU=<span class="ex">opt</span>/<span class="va">CN=</span>www.linuxpanda.tech</a>
<a class="sourceLine" id="cb4-5" data-line-number="5"></a>
<a class="sourceLine" id="cb4-6" data-line-number="6">[<span class="ex">root@localhost</span> CA]# make revoke crt=certs/httpd.crt</a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="ex">/usr/bin/openssl</span> ca -revoke certs/httpd.crt <span class="kw">;</span> <span class="kw">\</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8">        <span class="ex">/usr/bin/openssl</span> ca -gencrl -out crl/ca.crl </a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="ex">Using</span> configuration from /etc/pki/tls/openssl.cnf</a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="ex">Revoking</span> Certificate 01.</a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="ex">Data</span> Base Updated</a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="ex">Using</span> configuration from /etc/pki/tls/openssl.cnf</a>
<a class="sourceLine" id="cb4-13" data-line-number="13">[<span class="ex">root@localhost</span> CA]# make showcrl</a>
<a class="sourceLine" id="cb4-14" data-line-number="14"><span class="ex">/usr/bin/openssl</span> crl -in crl/ca.crl -noout -text</a>
<a class="sourceLine" id="cb4-15" data-line-number="15"><span class="ex">Certificate</span> Revocation List (CRL)<span class="bu">:</span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16">        <span class="ex">Version</span> 2 (0x1)</a>
<a class="sourceLine" id="cb4-17" data-line-number="17">    <span class="ex">Signature</span> Algorithm: sha256WithRSAEncryption</a>
<a class="sourceLine" id="cb4-18" data-line-number="18">        <span class="ex">Issuer</span>: /C=cn/ST=henan/L=zhengzhou/O=linuxpanda/OU=opt/CN=ca.linuxpanda.tech</a>
<a class="sourceLine" id="cb4-19" data-line-number="19">        <span class="ex">Last</span> Update: Feb 13 04:53:35 2018 GMT</a>
<a class="sourceLine" id="cb4-20" data-line-number="20">        <span class="ex">Next</span> Update: Mar 15 04:53:35 2018 GMT</a>
<a class="sourceLine" id="cb4-21" data-line-number="21">        <span class="ex">CRL</span> extensions:</a>
<a class="sourceLine" id="cb4-22" data-line-number="22">            <span class="ex">X509v3</span> CRL Number: </a>
<a class="sourceLine" id="cb4-23" data-line-number="23">                <span class="ex">1</span></a>
<a class="sourceLine" id="cb4-24" data-line-number="24"><span class="ex">Revoked</span> Certificates:</a>
<a class="sourceLine" id="cb4-25" data-line-number="25">    <span class="ex">Serial</span> Number: 01</a>
<a class="sourceLine" id="cb4-26" data-line-number="26">        <span class="ex">Revocation</span> Date: Feb 13 04:53:35 2018 GMT</a>
<a class="sourceLine" id="cb4-27" data-line-number="27">    <span class="ex">Signature</span> Algorithm: sha256WithRSAEncryption</a>
<a class="sourceLine" id="cb4-28" data-line-number="28">        <span class="ex">48</span>:3e:bb:f4:6c:1a:e3:61:5d:c7:68:db:37:2f:97:e4:18:c7:</a>
<a class="sourceLine" id="cb4-29" data-line-number="29">        <span class="ex">dc</span>:40:56:7b:60:13:d7:07:9f:5e:e5:7b:0d:f4:33:fc:5a:a9:</a>
<a class="sourceLine" id="cb4-30" data-line-number="30">        <span class="ex">1d</span>:5f:ee:b9:64:cf:80:bc:a5:0c:fe:e5:ba:9a:f7:cc:1c:54:</a>
<a class="sourceLine" id="cb4-31" data-line-number="31">        <span class="ex">63</span>:53:d9:44:cc:a5:2c:0b:98:b5:c1:4a:2e:ca:27:3c:c9:4e:</a>
<a class="sourceLine" id="cb4-32" data-line-number="32">        <span class="ex">f4</span>:af:8b:7a:13:52:78:e1:84:96:1a:e0:64:4b:6b:a4:f2:c0:</a>
<a class="sourceLine" id="cb4-33" data-line-number="33">        <span class="ex">42</span>:37:f4:23:da:32:04:87:43:aa:97:c7:e9:16:2a:88:df:6a:</a>
<a class="sourceLine" id="cb4-34" data-line-number="34">        <span class="ex">26</span>:45:74:4e:6b:36:d5:6d:d7:13:82:e4:57:8e:31:5d:71:73:</a>
<a class="sourceLine" id="cb4-35" data-line-number="35">        <span class="ex">1a</span>:a9:cb:76:c9:48:b1:ca:6a:b9:00:c2:07:4e:35:5b:18:0b:</a>
<a class="sourceLine" id="cb4-36" data-line-number="36">        <span class="ex">db</span>:e6:0e:df:ef:75:da:ab:58:01:b4:ab:9c:89:85:f5:4c:67:</a>
<a class="sourceLine" id="cb4-37" data-line-number="37">        <span class="ex">2b</span>:61:3e:e3:f0:bd:7d:39:1a:d3:ce:1d:28:55:a1:cb:92:8f:</a>
<a class="sourceLine" id="cb4-38" data-line-number="38">        <span class="ex">73</span>:ed:0e:77:7a:ec:56:97:d4:64:05:c8:05:8f:c8:d8:c5:7c:</a>
<a class="sourceLine" id="cb4-39" data-line-number="39">        <span class="ex">05</span>:24:f8:a4:98:ff:71:48:2d:2d:b3:a5:a2:de:c2:02:62:38:</a>
<a class="sourceLine" id="cb4-40" data-line-number="40">        <span class="ex">a4</span>:88:96:43:84:e2:9b:a4:a5:09:0f:3c:26:57:6b:f5:53:75:</a>
<a class="sourceLine" id="cb4-41" data-line-number="41">        <span class="ex">df</span>:08:c1:8a:ab:a7:26:66:b8:1f:21:26:c8:6c:11:27:10:6e:</a>
<a class="sourceLine" id="cb4-42" data-line-number="42">        <span class="ex">e2</span>:fa:29:7c</a></code></pre></div>
]]></content>
      
        <categories>
            
            <category> linux </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> ca </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[关于我]]></title>
      <url>/2018/02/07/aboutme/</url>
      <content type="html"><![CDATA[<h2 id="我的工作经历">我的工作经历</h2>
<h2 id="我的学习经历">我的学习经历</h2>
<h2 id="我的爱好">我的爱好</h2>
]]></content>
      
        <categories>
            
            <category> about </category>
            
        </categories>
        
        
        <tags>
            
            <tag> about </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[test_database]]></title>
      <url>/2018/02/02/test_database/</url>
      <content type="html"><![CDATA[<h2 id="test1">test1</h2>
<h3 id="test2">test2</h3>
<h3 id="test3">test3</h3>
<h3 id="test4">test4</h3>
<h2 id="test5">test5</h2>
<h3 id="test6">test6</h3>
<h4 id="test7">test7</h4>
<h2 id="test8">test8</h2>
<p>test9</p>
]]></content>
      
        <categories>
            
            <category> database </category>
            
        </categories>
        
        
        <tags>
            
            <tag> database </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[test_essay]]></title>
      <url>/2018/02/02/test_essay/</url>
      <content type="html"><![CDATA[
]]></content>
      
        <categories>
            
            <category> essay </category>
            
        </categories>
        
        
        <tags>
            
            <tag> essay </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[test_spider]]></title>
      <url>/2018/02/02/test_spider/</url>
      <content type="html"><![CDATA[
]]></content>
      
        <categories>
            
            <category> spider </category>
            
        </categories>
        
        
        <tags>
            
            <tag> spider </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[test_linux]]></title>
      <url>/2018/02/02/test_linux/</url>
      <content type="html"><![CDATA[
]]></content>
      
        <categories>
            
            <category> linux </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[test_python]]></title>
      <url>/2018/02/02/test_python/</url>
      <content type="html"><![CDATA[
]]></content>
      
        <categories>
            
            <category> python </category>
            
        </categories>
        
        
        <tags>
            
            <tag> python </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[test]]></title>
      <url>/2018/02/02/test/</url>
      <content type="html"><![CDATA[
]]></content>
      
        
    </entry>
    
    <entry>
      <title><![CDATA[mariadb多实例的三种实现]]></title>
      <url>/2018/02/02/mariadb%E5%A4%9A%E5%AE%9E%E4%BE%8B%E7%9A%84%E4%B8%89%E7%A7%8D%E5%AE%9E%E7%8E%B0/</url>
      <content type="html"><![CDATA[<p>mariadb多实例实现方式:</p>
<dl>
<dt>mysqld_multi</dt>
<dd><p>这个是使用单独的配置文件来配置多个实例，不过管理实例还是很方便的。</p>
</dd>
<dt>多个sysv配置</dt>
<dd><p>这个方式相当于每个mairadb实例为一个不同的服务而已，每个实例一套sysv脚本。 配置起来比较简单，如果实例过多管理起来比较麻烦。</p>
</dd>
<dt>systemd</dt>
<dd><p>这个是systemd管理的特有的。</p>
</dd>
</dl>
<h2 id="配置前规划">配置前规划</h2>
<p>上面mairadb的多实例有多种配置方法， 我们先规划如下：</p>
<table>
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>方案</th>
<th>主目录</th>
<th>端口规划</th>
<th>其他</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>方案1</td>
<td>/data/scheme1/mysql/</td>
<td>3307,3308</td>
<td></td>
</tr>
<tr class="even">
<td>方案2</td>
<td>/data/scheme2/mysql/</td>
<td>4307,4308</td>
<td></td>
</tr>
<tr class="odd">
<td>方案3</td>
<td>/data/scheme3/mysql/</td>
<td>5307,5308</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="配置前的环境设置">配置前的环境设置</h2>
<p>关闭selinux</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1">[<span class="ex">root@centos-158</span> ~]# setenforce 0</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">[<span class="ex">root@centos-158</span> ~]# sed -i <span class="st">&#39;s@SELINUX=.*@SELINUX=disabled@&#39;</span> /etc/sysconfig/selinux</a></code></pre></div>
<p>关闭防火墙</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" data-line-number="1">[<span class="ex">root@centos-158</span> ~]# systemctl stop firewalld</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">[<span class="ex">root@centos-158</span> ~]# systemctl disable firewalld</a></code></pre></div>
<h2 id="安装mariadb">安装mariadb</h2>
<p>这里我不使用centos默认的版本，使用最新稳定版本10.2。</p>
<p>上面的基础规划完毕，需要配置下 <a href="https://downloads.mariadb.org/mariadb/repositories/#mirror=neusoft&amp;distro=CentOS&amp;distro_release=centos7-amd64--centos7&amp;version=10.2" target="_blank" rel="noopener">mariadb的yum源</a>。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" data-line-number="1">[<span class="ex">root@centos-158</span> yum.repos.d]# vim mariadb.repo                             # 添加/etc/yum.repos.d/mariadb.repo文件</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">[<span class="ex">root@centos-158</span> yum.repos.d]# cat mariadb.repo                             # 检查这个文件</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">[<span class="ex">root@centos-158</span> yum.repos.d]# cat mariadb.repo </a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="co"># MariaDB 10.2 CentOS repository list - created 2018-01-27 14:09 UTC</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="co"># http://downloads.mariadb.org/mariadb/repositories/</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6">[<span class="ex">mariadb</span>]</a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="ex">name</span> = MariaDB</a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="co">#这个地方的配置是国外的，下载太慢了。 我给改成清华镜像站点的了，这样下载会快点。</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="ex">baseurl</span> =https://mirrors.tuna.tsinghua.edu.cn/mariadb//mariadb-10.2.12/yum/centos/7Server/x86_64/</a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="va">gpgkey=</span>https://yum.mariadb.org/RPM-GPG-KEY-MariaDB</a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="va">gpgcheck=</span>1</a>
<a class="sourceLine" id="cb3-12" data-line-number="12"></a>
<a class="sourceLine" id="cb3-13" data-line-number="13">[<span class="ex">root@centos-158</span> yum.repos.d]# yum install MariaDB-server MariaDB-client -y <span class="co"># 安装server和client</span></a></code></pre></div>
<div class="note">
<div class="admonition-title">
<p>Note</p>
</div>
<p>这个包名是区分大小写的，使用rpm查询包提供文件的时候注意大小写。</p>
</div>
<h2 id="方案1-mysqld_multi">方案1-mysqld_multi</h2>
<h3 id="创建目录并修改权限">创建目录并修改权限</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" data-line-number="1">[<span class="ex">root@centos-158</span> ~]# mkdir -pv /data/scheme1/mysql/<span class="dt">{3307,3308}</span>/data         # 创建目录</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">[<span class="ex">root@centos-158</span> ~]# chown mysql.mysql /data/scheme1/mysql/330<span class="dt">{7,8}</span> -R      # 修改权限</a></code></pre></div>
<h3 id="安装数据库">安装数据库</h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" data-line-number="1">[<span class="ex">root@centos-158</span> ~]# mysql_install_db  --datadir=/data/scheme1/mysql/3308/data --basedir=/usr --user=mysql  # 安装到数据目录</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">[<span class="ex">root@centos-158</span> ~]# mysql_install_db  --datadir=/data/scheme1/mysql/3308/data --basedir=/usr --user=mysql  # 安装到数据目录</a></code></pre></div>
<h3 id="配置文件">配置文件</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" data-line-number="1">[<span class="ex">root@centos-158</span> ~]# mv /etc/my.conf /etc/my.conf.yumbak                # 重命名文件，别影响接下来的实验，其实不必要的</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">[<span class="ex">root@centos-158</span> ~]# vim /etc/my.conf                                   # 编辑</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">[<span class="ex">root@centos-158</span> ~]# cat /etc/my.conf                                   # 查看</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">[<span class="ex">mysqld_multi</span>]</a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="ex">mysqld</span>     = /usr/bin/mysqld_safe</a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="ex">mysqladmin</span> = /usr/bin/mysqladmin</a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="ex">user</span>       = multi_admin</a>
<a class="sourceLine" id="cb6-8" data-line-number="8"><span class="ex">password</span>   = zhaojiedi</a>
<a class="sourceLine" id="cb6-9" data-line-number="9"></a>
<a class="sourceLine" id="cb6-10" data-line-number="10">[<span class="ex">mysqld3307</span>]</a>
<a class="sourceLine" id="cb6-11" data-line-number="11"><span class="ex">socket</span>     = /data/scheme1/mysql/3307/mariadb.sock</a>
<a class="sourceLine" id="cb6-12" data-line-number="12"><span class="ex">port</span>       = 3307</a>
<a class="sourceLine" id="cb6-13" data-line-number="13"><span class="ex">pid-file</span>   = /data/scheme1/mysql/3307/mariadb.pid </a>
<a class="sourceLine" id="cb6-14" data-line-number="14"><span class="ex">datadir</span>    = /data/scheme1/mysql/3307/data </a>
<a class="sourceLine" id="cb6-15" data-line-number="15"><span class="ex">user</span>       = mysql</a>
<a class="sourceLine" id="cb6-16" data-line-number="16"></a>
<a class="sourceLine" id="cb6-17" data-line-number="17">[<span class="ex">mysqld3308</span>]</a>
<a class="sourceLine" id="cb6-18" data-line-number="18"><span class="ex">socket</span>     = /data/scheme1/mysql/3308/mariadb.sock</a>
<a class="sourceLine" id="cb6-19" data-line-number="19"><span class="ex">port</span>       = 3308</a>
<a class="sourceLine" id="cb6-20" data-line-number="20"><span class="ex">pid-file</span>   = /data/scheme1/mysql/3308/mariadb.pid </a>
<a class="sourceLine" id="cb6-21" data-line-number="21"><span class="ex">datadir</span>    = /data/scheme1/mysql/3308/data </a>
<a class="sourceLine" id="cb6-22" data-line-number="22"><span class="ex">user</span>       = mysql</a></code></pre></div>
<div class="note">
<div class="admonition-title">
<p>Note</p>
</div>
<p>更多的参数官方文档。</p>
</div>
<h3 id="启动实例">启动实例</h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb7-1" data-line-number="1">[<span class="ex">root@centos-158</span> ~]# mysqld_multi start 3307                        # 启动指定的实例，这个是在配置mysqld3307片段，实例名字就是3307</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">[<span class="ex">root@centos-158</span> ~]# mysqld_multi start 3308                        # 启动指定的实例，这个是在配置mysqld3307片段，实例名字就是3307</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"></a>
<a class="sourceLine" id="cb7-4" data-line-number="4">[<span class="ex">root@centos-158</span> ~]# netstat -tunlp <span class="kw">|</span><span class="fu">grep</span> 330*                      # 查看服务</a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="ex">tcp6</span>       0      0 :::3307                 :::*                    LISTEN      2631/mysqld         </a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="ex">tcp6</span>       0      0 :::3308                 :::*                    LISTEN      2746/mysqld </a></code></pre></div>
<div class="note">
<div class="admonition-title">
<p>Note</p>
</div>
<p>mysqld_multi start 3307-3308来批量启动，多个矢量还可以逗号分割。</p>
</div>
<h3 id="安全初始化脚本运行">安全初始化脚本运行</h3>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb8-1" data-line-number="1">[<span class="ex">root@centos-158</span> ~]# mysql_secure_installation -S /data/scheme1/mysql/3307/mariadb.sock  # 使用socket连接3307实例</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="co"># 下面内容只跳出重要的输入项列出</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="ex">Enter</span> current password for root (enter for none)<span class="bu">:</span>              # 默认密码空，直接回车即可</a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="ex">Set</span> root password? [Y/n] y                                     # 输入y</a>
<a class="sourceLine" id="cb8-5" data-line-number="5"><span class="ex">New</span> password:                                                  # 输入root用户密码，注意不是系统密码，是数据库密码</a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="ex">Re-enter</span> new password:                                         # 再次确认</a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="ex">Remove</span> anonymous users? [Y/n] y                                # 移除匿名用户</a>
<a class="sourceLine" id="cb8-8" data-line-number="8"><span class="ex">Disallow</span> root login remotely? [Y/n] y                          # 禁止root用户远程登陆，这个看你具体情况设置</a>
<a class="sourceLine" id="cb8-9" data-line-number="9"><span class="ex">Remove</span> test database and access to it? [Y/n] y                 # 移除test数据库</a>
<a class="sourceLine" id="cb8-10" data-line-number="10"><span class="ex">Reload</span> privilege tables now? [Y/n] y                           # 刷新权限表</a>
<a class="sourceLine" id="cb8-11" data-line-number="11">[<span class="ex">root@centos-158</span> ~]# mysql_secure_installation -S /data/scheme1/mysql/3308/mariadb.sock  # 使用socket连接3308实例</a></code></pre></div>
<h3 id="添加多实例管理用户">添加多实例管理用户</h3>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb9-1" data-line-number="1">[<span class="ex">root@centos-158</span> ~]# vim create_user.sql                        # 添加用户脚本</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">[<span class="ex">root@centos-158</span> ~]# cat create_user.sql                        # 检查</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="ex">CREATE</span> USER <span class="st">&#39;multi_admin&#39;</span>@<span class="st">&#39;localhost&#39;</span> IDENTIFIED BY <span class="st">&#39;multi_admin&#39;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="ex">GRANT</span> SHUTDOWN ON *.* TO <span class="st">&#39;multi_admin&#39;</span>@<span class="st">&#39;localhost&#39;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="ex">flush</span> privileges<span class="kw">;</span> </a>
<a class="sourceLine" id="cb9-6" data-line-number="6"></a>
<a class="sourceLine" id="cb9-7" data-line-number="7">[<span class="ex">root@centos-158</span> ~]# cat create_user.sql <span class="kw">|</span> <span class="ex">mysql</span> -u root -S /data/scheme1/mysql/3307/mariadb.sock -p <span class="co">#执行脚本</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8"><span class="ex">Enter</span> password: </a>
<a class="sourceLine" id="cb9-9" data-line-number="9">[<span class="ex">root@centos-158</span> ~]# cat create_user.sql <span class="kw">|</span> <span class="ex">mysql</span> -u root -S /data/scheme1/mysql/3308/mariadb.sock -p <span class="co"># 执行脚本</span></a>
<a class="sourceLine" id="cb9-10" data-line-number="10"><span class="ex">Enter</span> password: </a></code></pre></div>
<p>更多 <a href="https://dev.mysql.com/doc/refman/5.7/en/mysqld-multi.html" target="_blank" rel="noopener">mysqld-multi</a> 使用帮助。</p>
<h3 id="查看和关闭实例">查看和关闭实例</h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb10-1" data-line-number="1">[<span class="ex">root@centos-158</span> ~]# mysqld_multi report                        # 查看服务状态</a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="ex">Reporting</span> MariaDB servers</a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="ex">MariaDB</span> server from group: mysqld3307 is running</a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="ex">MariaDB</span> server from group: mysqld3308 is running</a>
<a class="sourceLine" id="cb10-5" data-line-number="5">[<span class="ex">root@centos-158</span> ~]# mysqld_multi stop 3307                     # 关闭一个实例</a>
<a class="sourceLine" id="cb10-6" data-line-number="6">[<span class="ex">root@centos-158</span> ~]# mysqld_multi report                        # 查看服务状态</a>
<a class="sourceLine" id="cb10-7" data-line-number="7"><span class="ex">Reporting</span> MariaDB servers</a>
<a class="sourceLine" id="cb10-8" data-line-number="8"><span class="ex">MariaDB</span> server from group: mysqld3307 is not running</a>
<a class="sourceLine" id="cb10-9" data-line-number="9"><span class="ex">MariaDB</span> server from group: mysqld3308 is running</a></code></pre></div>
<h3 id="开机启动">开机启动</h3>
<p>直接加入到rc.local中</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb11-1" data-line-number="1">[<span class="ex">root@centos-158</span> ~]# echo <span class="kw">`</span><span class="fu">which</span> mysqld_multi<span class="kw">`</span> start 3307-3308  <span class="op">&gt;&gt;</span> /etc/rc.local        # 开机执行</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">[<span class="ex">root@centos-158</span> ~]# tail -n 1 /etc/rc.local </a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="ex">/usr/bin/mysqld_multi</span> start 3307-3308</a></code></pre></div>
<p>上面的加入rc.local方式管理上容易混乱，还是写个sysv脚本好些。</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb12-1" data-line-number="1">[<span class="ex">root@centos-158</span> init.d]# cd /etc/rc.d/init.d/</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">[<span class="ex">root@centos-158</span> init.d]# vim mysqld_multi </a>
<a class="sourceLine" id="cb12-3" data-line-number="3">[<span class="ex">root@centos-158</span> init.d]# cat mysqld_multi </a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="co">#! /bin/bash</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="co"># chkconfig: 2345 90 10</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="co"># description: mysqld_multi</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"></a>
<a class="sourceLine" id="cb12-8" data-line-number="8"><span class="co"># See how we were called.</span></a>
<a class="sourceLine" id="cb12-9" data-line-number="9"><span class="va">mysqld_multi=</span>/usr/local/mysql/bin/mysqld_multi</a>
<a class="sourceLine" id="cb12-10" data-line-number="10"><span class="co"># 实例列表</span></a>
<a class="sourceLine" id="cb12-11" data-line-number="11"><span class="va">instance_list=</span><span class="st">&quot;3307-3308&quot;</span></a>
<a class="sourceLine" id="cb12-12" data-line-number="12"><span class="co">#instance_list=&quot;3307,3308,3309-3310&quot;</span></a>
<a class="sourceLine" id="cb12-13" data-line-number="13"><span class="fu">start()</span><span class="kw">{</span></a>
<a class="sourceLine" id="cb12-14" data-line-number="14">    <span class="va">$mysqld_multi</span> <span class="ex">start</span> <span class="va">$instance_list</span>  </a>
<a class="sourceLine" id="cb12-15" data-line-number="15"><span class="kw">}</span></a>
<a class="sourceLine" id="cb12-16" data-line-number="16"><span class="fu">stop()</span><span class="kw">{</span></a>
<a class="sourceLine" id="cb12-17" data-line-number="17">    <span class="va">$mysqld_multi</span> <span class="ex">stop</span> <span class="va">$instance_list</span></a>
<a class="sourceLine" id="cb12-18" data-line-number="18"><span class="kw">}</span></a>
<a class="sourceLine" id="cb12-19" data-line-number="19"><span class="fu">status()</span><span class="kw">{</span></a>
<a class="sourceLine" id="cb12-20" data-line-number="20">    <span class="va">$mysqld_multi</span> <span class="ex">report</span></a>
<a class="sourceLine" id="cb12-21" data-line-number="21"><span class="kw">}</span></a>
<a class="sourceLine" id="cb12-22" data-line-number="22"><span class="kw">case</span> <span class="st">&quot;</span><span class="va">$1</span><span class="st">&quot;</span><span class="kw"> in</span></a>
<a class="sourceLine" id="cb12-23" data-line-number="23">start<span class="kw">)</span></a>
<a class="sourceLine" id="cb12-24" data-line-number="24">    <span class="ex">start</span></a>
<a class="sourceLine" id="cb12-25" data-line-number="25">        <span class="kw">;;</span></a>
<a class="sourceLine" id="cb12-26" data-line-number="26">stop<span class="kw">)</span></a>
<a class="sourceLine" id="cb12-27" data-line-number="27">    <span class="ex">stop</span></a>
<a class="sourceLine" id="cb12-28" data-line-number="28">        <span class="kw">;;</span></a>
<a class="sourceLine" id="cb12-29" data-line-number="29">status<span class="kw">)</span></a>
<a class="sourceLine" id="cb12-30" data-line-number="30">    <span class="ex">status</span></a>
<a class="sourceLine" id="cb12-31" data-line-number="31">        <span class="kw">;;</span></a>
<a class="sourceLine" id="cb12-32" data-line-number="32">restart<span class="kw">)</span></a>
<a class="sourceLine" id="cb12-33" data-line-number="33">    <span class="ex">start</span></a>
<a class="sourceLine" id="cb12-34" data-line-number="34">    <span class="ex">stop</span></a>
<a class="sourceLine" id="cb12-35" data-line-number="35">        <span class="kw">;;</span></a>
<a class="sourceLine" id="cb12-36" data-line-number="36">*<span class="kw">)</span></a>
<a class="sourceLine" id="cb12-37" data-line-number="37">    <span class="bu">echo</span> <span class="st">$&quot;Usage: </span><span class="va">$0</span><span class="st"> {start|stop|status}&quot;</span></a>
<a class="sourceLine" id="cb12-38" data-line-number="38">    <span class="bu">exit</span> 2</a>
<a class="sourceLine" id="cb12-39" data-line-number="39"><span class="kw">esac</span></a>
<a class="sourceLine" id="cb12-40" data-line-number="40"></a>
<a class="sourceLine" id="cb12-41" data-line-number="41">[<span class="ex">root@centos-158</span> init.d]# chkconfig --add mysqld_multi                  # 添加sysv</a>
<a class="sourceLine" id="cb12-42" data-line-number="42">[<span class="ex">root@centos-158</span> init.d]# chkconfig mysqld_multi on                     # 启用mysqld_multi</a></code></pre></div>
<h2 id="方案2-多sysv脚本">方案2-多sysv脚本</h2>
<h3 id="创建目录并修改权限-1">创建目录并修改权限</h3>
<p>这种方式，需要每个配置文件都要单独存放，可以给目录更详细的规划下</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb13-1" data-line-number="1">[<span class="ex">root@centos-158</span> ~]#  mkdir -pv /data/scheme2/mysql/<span class="dt">{4307,4308}/{data,etc,log,socket,pid,service}</span>       # 创建目录</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">[<span class="ex">root@centos-158</span> ~]# chown mysql.mysql /data/scheme2/mysql/4307 -R                                      # 修改所有者</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">[<span class="ex">root@centos-158</span> ~]# chown mysql.mysql /data/scheme2/mysql/4308 -R                                      # 修改所有者</a></code></pre></div>
<h3 id="安装数据库-1">安装数据库</h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb14-1" data-line-number="1">[<span class="ex">root@centos-158</span> ~]# mysql_install_db  --datadir=/data/scheme2/mysql/4307/data --basedir=/usr --user=mysql  # 安装数据库</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">[<span class="ex">root@centos-158</span> ~]# mysql_install_db  --datadir=/data/scheme2/mysql/4308/data --basedir=/usr --user=mysql  # 安装数据库</a></code></pre></div>
<h3 id="配置配置文件">配置配置文件</h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb15-1" data-line-number="1">[<span class="ex">root@centos-158</span> ~]# cd /data/scheme2/mysql/4307/etc/                           # 进入配置目录</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">[<span class="ex">root@centos-158</span> etc]# vim my.cnf                                               # 编辑单独的配置文件              </a>
<a class="sourceLine" id="cb15-3" data-line-number="3">[<span class="ex">root@centos-158</span> etc]# cat my.cnf                                               # 检查</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">[<span class="ex">mysqld</span>]</a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="va">port=</span>4307</a>
<a class="sourceLine" id="cb15-6" data-line-number="6"><span class="va">datadir=</span>/data/scheme2/mysql/4307/data</a>
<a class="sourceLine" id="cb15-7" data-line-number="7"><span class="va">socket=</span>/data/scheme2/mysql/4307/socket/mariadb.sock</a>
<a class="sourceLine" id="cb15-8" data-line-number="8">[<span class="ex">mysqld-safe</span>]</a>
<a class="sourceLine" id="cb15-9" data-line-number="9"><span class="ex">log-error</span>=/data/scheme2/mysql/4307/log/mariadb.log</a>
<a class="sourceLine" id="cb15-10" data-line-number="10"><span class="ex">pid-file</span>=/data/scheme2/mysql/4308/pid/mariadb.pid</a>
<a class="sourceLine" id="cb15-11" data-line-number="11"></a>
<a class="sourceLine" id="cb15-12" data-line-number="12">[<span class="ex">root@centos-158</span> etc]# cp my.cnf ../../4308/etc/my.cnf                          # 复制到另一个实例中去</a>
<a class="sourceLine" id="cb15-13" data-line-number="13">[<span class="ex">root@centos-158</span> etc]# sed -i <span class="st">&#39;s@4307@4308@&#39;</span> ../../4308/etc/my.cnf              # 修改配置的端口</a>
<a class="sourceLine" id="cb15-14" data-line-number="14">[<span class="ex">root@centos-158</span> etc]# cat ../../4308/etc/my.cnf                                # 检查</a>
<a class="sourceLine" id="cb15-15" data-line-number="15">[<span class="ex">mysqld</span>]</a>
<a class="sourceLine" id="cb15-16" data-line-number="16"><span class="va">port=</span>4308</a>
<a class="sourceLine" id="cb15-17" data-line-number="17"><span class="va">datadir=</span>/data/scheme2/mysql/4308/data</a>
<a class="sourceLine" id="cb15-18" data-line-number="18"><span class="va">socket=</span>/data/scheme2/mysql/4308/socket/mariadb.sock</a>
<a class="sourceLine" id="cb15-19" data-line-number="19">[<span class="ex">mysqld-safe</span>]</a>
<a class="sourceLine" id="cb15-20" data-line-number="20"><span class="ex">log-error</span>=/data/scheme2/mysql/4308/log/mariadb.log</a>
<a class="sourceLine" id="cb15-21" data-line-number="21"><span class="ex">pid-file</span>=/data/scheme2/mysql/4308/pid/mariadb.pid</a></code></pre></div>
<h3 id="配置服务文件">配置服务文件</h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb16-1" data-line-number="1">[<span class="ex">root@centos-158</span> 4307]# vim service/mysqld.sh                                   # 编辑sysv脚本</a>
<a class="sourceLine" id="cb16-2" data-line-number="2">[<span class="ex">root@centos-158</span> 4307]# cat service/mysqld.sh                                   # 检查</a>
<a class="sourceLine" id="cb16-3" data-line-number="3"><span class="co">#!/bin/bash</span></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"><span class="co"># chkconfig: 2345 91 19</span></a>
<a class="sourceLine" id="cb16-5" data-line-number="5"><span class="co"># description: manage mariadb </span></a>
<a class="sourceLine" id="cb16-6" data-line-number="6"></a>
<a class="sourceLine" id="cb16-7" data-line-number="7"><span class="va">port=</span>4307</a>
<a class="sourceLine" id="cb16-8" data-line-number="8"><span class="va">mysql_user=</span><span class="st">&quot;root&quot;</span></a>
<a class="sourceLine" id="cb16-9" data-line-number="9"><span class="va">mysql_pwd=</span><span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb16-10" data-line-number="10"><span class="va">mysql_basedir=</span><span class="st">&quot;/data/scheme2/mysql&quot;</span></a>
<a class="sourceLine" id="cb16-11" data-line-number="11"><span class="co">#cmd_path=&quot;${mysql_basedir}/${port}/bin&quot;</span></a>
<a class="sourceLine" id="cb16-12" data-line-number="12"><span class="va">cmd_path=</span><span class="st">&quot;/usr/bin&quot;</span></a>
<a class="sourceLine" id="cb16-13" data-line-number="13"><span class="va">mysql_sock=</span><span class="st">&quot;</span><span class="va">${mysql_basedir}</span><span class="st">/</span><span class="va">${port}</span><span class="st">/socket/mariadb.sock&quot;</span></a>
<a class="sourceLine" id="cb16-14" data-line-number="14"></a>
<a class="sourceLine" id="cb16-15" data-line-number="15"><span class="fu">function_start_mysql()</span></a>
<a class="sourceLine" id="cb16-16" data-line-number="16"><span class="kw">{</span></a>
<a class="sourceLine" id="cb16-17" data-line-number="17">    <span class="kw">if</span><span class="bu"> [</span> <span class="ot">!</span> <span class="ot">-e</span> <span class="st">&quot;</span><span class="va">$mysql_sock</span><span class="st">&quot;</span><span class="bu"> ]</span>;<span class="kw">then</span></a>
<a class="sourceLine" id="cb16-18" data-line-number="18">    <span class="bu">printf</span> <span class="st">&quot;Starting MySQL...\n&quot;</span></a>
<a class="sourceLine" id="cb16-19" data-line-number="19">    <span class="va">cmd=</span><span class="st">&quot;</span><span class="va">${cmd_path}</span><span class="st">/mysqld_safe --defaults-file=</span><span class="va">${mysql_basedir}</span><span class="st">/</span><span class="va">${port}</span><span class="st">/etc/my.cnf&quot;</span></a>
<a class="sourceLine" id="cb16-20" data-line-number="20">    <span class="bu">printf</span> <span class="st">&quot;</span><span class="va">$cmd</span><span class="st">\n&quot;</span></a>
<a class="sourceLine" id="cb16-21" data-line-number="21">    <span class="va">${cmd_path}</span><span class="ex">/mysqld_safe</span> --defaults-file=<span class="va">${mysql_basedir}</span>/<span class="va">${port}</span>/etc/my.cnf  <span class="op">&amp;&gt;</span> /dev/null  <span class="kw">&amp;</span></a>
<a class="sourceLine" id="cb16-22" data-line-number="22">    <span class="kw">else</span></a>
<a class="sourceLine" id="cb16-23" data-line-number="23">    <span class="bu">printf</span> <span class="st">&quot;MySQL is running...\n&quot;</span></a>
<a class="sourceLine" id="cb16-24" data-line-number="24">    <span class="bu">exit</span></a>
<a class="sourceLine" id="cb16-25" data-line-number="25">    <span class="kw">fi</span></a>
<a class="sourceLine" id="cb16-26" data-line-number="26"><span class="kw">}</span></a>
<a class="sourceLine" id="cb16-27" data-line-number="27"><span class="fu">function_status_mysql()</span><span class="kw">{</span></a>
<a class="sourceLine" id="cb16-28" data-line-number="28">        <span class="kw">if</span><span class="bu"> [</span> <span class="ot">-e</span> <span class="st">&quot;</span><span class="va">$mysql_sock</span><span class="st">&quot;</span><span class="bu"> ]</span> ; <span class="kw">then</span></a>
<a class="sourceLine" id="cb16-29" data-line-number="29">                <span class="bu">printf</span> <span class="st">&quot;MySql is running...\n&quot;</span></a>
<a class="sourceLine" id="cb16-30" data-line-number="30">        <span class="kw">else</span></a>
<a class="sourceLine" id="cb16-31" data-line-number="31">                <span class="bu">printf</span> <span class="st">&quot;MySql is stopped...\n&quot;</span></a>
<a class="sourceLine" id="cb16-32" data-line-number="32">        <span class="kw">fi</span></a>
<a class="sourceLine" id="cb16-33" data-line-number="33"><span class="kw">}</span></a>
<a class="sourceLine" id="cb16-34" data-line-number="34"></a>
<a class="sourceLine" id="cb16-35" data-line-number="35"><span class="fu">function_stop_mysql()</span></a>
<a class="sourceLine" id="cb16-36" data-line-number="36"><span class="kw">{</span></a>
<a class="sourceLine" id="cb16-37" data-line-number="37">    <span class="kw">if</span><span class="bu"> [</span> <span class="ot">!</span> <span class="ot">-e</span> <span class="st">&quot;</span><span class="va">$mysql_sock</span><span class="st">&quot;</span><span class="bu"> ]</span>;<span class="kw">then</span></a>
<a class="sourceLine" id="cb16-38" data-line-number="38">    <span class="bu">printf</span> <span class="st">&quot;MySQL is stopped...\n&quot;</span></a>
<a class="sourceLine" id="cb16-39" data-line-number="39">    <span class="bu">exit</span></a>
<a class="sourceLine" id="cb16-40" data-line-number="40">    <span class="kw">else</span></a>
<a class="sourceLine" id="cb16-41" data-line-number="41">    <span class="bu">printf</span> <span class="st">&quot;Stoping MySQL...\n&quot;</span></a>
<a class="sourceLine" id="cb16-42" data-line-number="42">    <span class="va">${cmd_path}</span><span class="ex">/mysqladmin</span> -u <span class="va">${mysql_user}</span> -p<span class="va">${mysql_pwd}</span> -S <span class="va">${mysql_sock}</span> shutdown</a>
<a class="sourceLine" id="cb16-43" data-line-number="43"><span class="kw">fi</span></a>
<a class="sourceLine" id="cb16-44" data-line-number="44"><span class="kw">}</span></a>
<a class="sourceLine" id="cb16-45" data-line-number="45"></a>
<a class="sourceLine" id="cb16-46" data-line-number="46"></a>
<a class="sourceLine" id="cb16-47" data-line-number="47"><span class="fu">function_restart_mysql()</span></a>
<a class="sourceLine" id="cb16-48" data-line-number="48"><span class="kw">{</span></a>
<a class="sourceLine" id="cb16-49" data-line-number="49">    <span class="bu">printf</span> <span class="st">&quot;Restarting MySQL...\n&quot;</span></a>
<a class="sourceLine" id="cb16-50" data-line-number="50">    <span class="ex">function_stop_mysql</span></a>
<a class="sourceLine" id="cb16-51" data-line-number="51">    <span class="fu">sleep</span> 2</a>
<a class="sourceLine" id="cb16-52" data-line-number="52">    <span class="ex">function_start_mysql</span></a>
<a class="sourceLine" id="cb16-53" data-line-number="53"><span class="kw">}</span></a>
<a class="sourceLine" id="cb16-54" data-line-number="54"></a>
<a class="sourceLine" id="cb16-55" data-line-number="55"><span class="kw">case</span> <span class="va">$1</span><span class="kw"> in</span></a>
<a class="sourceLine" id="cb16-56" data-line-number="56">start<span class="kw">)</span></a>
<a class="sourceLine" id="cb16-57" data-line-number="57">        <span class="ex">function_start_mysql</span></a>
<a class="sourceLine" id="cb16-58" data-line-number="58">        <span class="kw">;;</span></a>
<a class="sourceLine" id="cb16-59" data-line-number="59">stop<span class="kw">)</span></a>
<a class="sourceLine" id="cb16-60" data-line-number="60">        <span class="ex">function_stop_mysql</span></a>
<a class="sourceLine" id="cb16-61" data-line-number="61">        <span class="kw">;;</span></a>
<a class="sourceLine" id="cb16-62" data-line-number="62">restart<span class="kw">)</span></a>
<a class="sourceLine" id="cb16-63" data-line-number="63">        <span class="ex">function_restart_mysql</span></a>
<a class="sourceLine" id="cb16-64" data-line-number="64">        <span class="kw">;;</span></a>
<a class="sourceLine" id="cb16-65" data-line-number="65">status<span class="kw">)</span></a>
<a class="sourceLine" id="cb16-66" data-line-number="66">        <span class="ex">function_status_mysql</span></a>
<a class="sourceLine" id="cb16-67" data-line-number="67">        <span class="kw">;;</span></a>
<a class="sourceLine" id="cb16-68" data-line-number="68">*<span class="kw">)</span></a>
<a class="sourceLine" id="cb16-69" data-line-number="69">    <span class="bu">printf</span> <span class="st">&quot;Usage: </span><span class="va">${cmd_path}</span><span class="st">/mysqld {start|stop|restart|status}\n&quot;</span></a>
<a class="sourceLine" id="cb16-70" data-line-number="70"><span class="kw">esac</span></a>
<a class="sourceLine" id="cb16-71" data-line-number="71"></a>
<a class="sourceLine" id="cb16-72" data-line-number="72"></a>
<a class="sourceLine" id="cb16-73" data-line-number="73">[<span class="ex">root@centos-158</span> 4307]# cp service/mysqld.sh  ../4308/service/mysqld.sh     # 复制一份</a>
<a class="sourceLine" id="cb16-74" data-line-number="74">[<span class="ex">root@centos-158</span> 4307]# sed -i <span class="st">&#39;s@4307@4308@&#39;</span> ../4308/service/mysqld.sh     # 修改端口</a>
<a class="sourceLine" id="cb16-75" data-line-number="75">[<span class="ex">root@centos-158</span> 4307]# cat ../4308/service/mysqld.sh                       # 检查</a>
<a class="sourceLine" id="cb16-76" data-line-number="76"><span class="co">#!/bin/bash</span></a>
<a class="sourceLine" id="cb16-77" data-line-number="77"><span class="co"># chkconfig: 2345 91 19</span></a>
<a class="sourceLine" id="cb16-78" data-line-number="78"><span class="co"># description: manage mariadb </span></a>
<a class="sourceLine" id="cb16-79" data-line-number="79"></a>
<a class="sourceLine" id="cb16-80" data-line-number="80"><span class="va">port=</span>4308</a>
<a class="sourceLine" id="cb16-81" data-line-number="81"><span class="va">mysql_user=</span><span class="st">&quot;root&quot;</span></a>
<a class="sourceLine" id="cb16-82" data-line-number="82"><span class="va">mysql_pwd=</span><span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb16-83" data-line-number="83"><span class="va">mysql_basedir=</span><span class="st">&quot;/data/scheme2/mysql&quot;</span></a>
<a class="sourceLine" id="cb16-84" data-line-number="84"><span class="co">#cmd_path=&quot;${mysql_basedir}/${port}/bin&quot;</span></a>
<a class="sourceLine" id="cb16-85" data-line-number="85"><span class="va">cmd_path=</span><span class="st">&quot;/usr/bin&quot;</span></a>
<a class="sourceLine" id="cb16-86" data-line-number="86"><span class="va">mysql_sock=</span><span class="st">&quot;</span><span class="va">${mysql_basedir}</span><span class="st">/</span><span class="va">${port}</span><span class="st">/socket/mariadb.sock&quot;</span></a>
<a class="sourceLine" id="cb16-87" data-line-number="87"></a>
<a class="sourceLine" id="cb16-88" data-line-number="88"><span class="fu">function_start_mysql()</span></a>
<a class="sourceLine" id="cb16-89" data-line-number="89"><span class="kw">{</span></a>
<a class="sourceLine" id="cb16-90" data-line-number="90">    <span class="kw">if</span><span class="bu"> [</span> <span class="ot">!</span> <span class="ot">-e</span> <span class="st">&quot;</span><span class="va">$mysql_sock</span><span class="st">&quot;</span><span class="bu"> ]</span>;<span class="kw">then</span></a>
<a class="sourceLine" id="cb16-91" data-line-number="91">    <span class="bu">printf</span> <span class="st">&quot;Starting MySQL...\n&quot;</span></a>
<a class="sourceLine" id="cb16-92" data-line-number="92">    <span class="va">cmd=</span><span class="st">&quot;</span><span class="va">${cmd_path}</span><span class="st">/mysqld_safe --defaults-file=</span><span class="va">${mysql_basedir}</span><span class="st">/</span><span class="va">${port}</span><span class="st">/etc/my.cnf&quot;</span></a>
<a class="sourceLine" id="cb16-93" data-line-number="93">    <span class="bu">printf</span> <span class="st">&quot;</span><span class="va">$cmd</span><span class="st">\n&quot;</span></a>
<a class="sourceLine" id="cb16-94" data-line-number="94">    <span class="va">${cmd_path}</span><span class="ex">/mysqld_safe</span> --defaults-file=<span class="va">${mysql_basedir}</span>/<span class="va">${port}</span>/etc/my.cnf  <span class="op">&amp;&gt;</span> /dev/null  <span class="kw">&amp;</span></a>
<a class="sourceLine" id="cb16-95" data-line-number="95">    <span class="kw">else</span></a>
<a class="sourceLine" id="cb16-96" data-line-number="96">    <span class="bu">printf</span> <span class="st">&quot;MySQL is running...\n&quot;</span></a>
<a class="sourceLine" id="cb16-97" data-line-number="97">    <span class="bu">exit</span></a>
<a class="sourceLine" id="cb16-98" data-line-number="98">    <span class="kw">fi</span></a>
<a class="sourceLine" id="cb16-99" data-line-number="99"><span class="kw">}</span></a>
<a class="sourceLine" id="cb16-100" data-line-number="100"><span class="fu">function_status_mysql()</span><span class="kw">{</span></a>
<a class="sourceLine" id="cb16-101" data-line-number="101">        <span class="kw">if</span><span class="bu"> [</span> <span class="ot">-e</span> <span class="st">&quot;</span><span class="va">$mysql_sock</span><span class="st">&quot;</span><span class="bu"> ]</span> ; <span class="kw">then</span></a>
<a class="sourceLine" id="cb16-102" data-line-number="102">                <span class="bu">printf</span> <span class="st">&quot;MySql is running...\n&quot;</span></a>
<a class="sourceLine" id="cb16-103" data-line-number="103">        <span class="kw">else</span></a>
<a class="sourceLine" id="cb16-104" data-line-number="104">                <span class="bu">printf</span> <span class="st">&quot;MySql is stopped...\n&quot;</span></a>
<a class="sourceLine" id="cb16-105" data-line-number="105">        <span class="kw">fi</span></a>
<a class="sourceLine" id="cb16-106" data-line-number="106"><span class="kw">}</span></a>
<a class="sourceLine" id="cb16-107" data-line-number="107"></a>
<a class="sourceLine" id="cb16-108" data-line-number="108"><span class="fu">function_stop_mysql()</span></a>
<a class="sourceLine" id="cb16-109" data-line-number="109"><span class="kw">{</span></a>
<a class="sourceLine" id="cb16-110" data-line-number="110">    <span class="kw">if</span><span class="bu"> [</span> <span class="ot">!</span> <span class="ot">-e</span> <span class="st">&quot;</span><span class="va">$mysql_sock</span><span class="st">&quot;</span><span class="bu"> ]</span>;<span class="kw">then</span></a>
<a class="sourceLine" id="cb16-111" data-line-number="111">    <span class="bu">printf</span> <span class="st">&quot;MySQL is stopped...\n&quot;</span></a>
<a class="sourceLine" id="cb16-112" data-line-number="112">    <span class="bu">exit</span></a>
<a class="sourceLine" id="cb16-113" data-line-number="113">    <span class="kw">else</span></a>
<a class="sourceLine" id="cb16-114" data-line-number="114">    <span class="bu">printf</span> <span class="st">&quot;Stoping MySQL...\n&quot;</span></a>
<a class="sourceLine" id="cb16-115" data-line-number="115">    <span class="va">${cmd_path}</span><span class="ex">/mysqladmin</span> -u <span class="va">${mysql_user}</span> -p<span class="va">${mysql_pwd}</span> -S <span class="va">${mysql_sock}</span> shutdown</a>
<a class="sourceLine" id="cb16-116" data-line-number="116"><span class="kw">fi</span></a>
<a class="sourceLine" id="cb16-117" data-line-number="117"><span class="kw">}</span></a>
<a class="sourceLine" id="cb16-118" data-line-number="118"></a>
<a class="sourceLine" id="cb16-119" data-line-number="119"></a>
<a class="sourceLine" id="cb16-120" data-line-number="120"><span class="fu">function_restart_mysql()</span></a>
<a class="sourceLine" id="cb16-121" data-line-number="121"><span class="kw">{</span></a>
<a class="sourceLine" id="cb16-122" data-line-number="122">    <span class="bu">printf</span> <span class="st">&quot;Restarting MySQL...\n&quot;</span></a>
<a class="sourceLine" id="cb16-123" data-line-number="123">    <span class="ex">function_stop_mysql</span></a>
<a class="sourceLine" id="cb16-124" data-line-number="124">    <span class="fu">sleep</span> 2</a>
<a class="sourceLine" id="cb16-125" data-line-number="125">    <span class="ex">function_start_mysql</span></a>
<a class="sourceLine" id="cb16-126" data-line-number="126"><span class="kw">}</span></a>
<a class="sourceLine" id="cb16-127" data-line-number="127"></a>
<a class="sourceLine" id="cb16-128" data-line-number="128"><span class="kw">case</span> <span class="va">$1</span><span class="kw"> in</span></a>
<a class="sourceLine" id="cb16-129" data-line-number="129">start<span class="kw">)</span></a>
<a class="sourceLine" id="cb16-130" data-line-number="130">        <span class="ex">function_start_mysql</span></a>
<a class="sourceLine" id="cb16-131" data-line-number="131">        <span class="kw">;;</span></a>
<a class="sourceLine" id="cb16-132" data-line-number="132">stop<span class="kw">)</span></a>
<a class="sourceLine" id="cb16-133" data-line-number="133">        <span class="ex">function_stop_mysql</span></a>
<a class="sourceLine" id="cb16-134" data-line-number="134">        <span class="kw">;;</span></a>
<a class="sourceLine" id="cb16-135" data-line-number="135">restart<span class="kw">)</span></a>
<a class="sourceLine" id="cb16-136" data-line-number="136">        <span class="ex">function_restart_mysql</span></a>
<a class="sourceLine" id="cb16-137" data-line-number="137">        <span class="kw">;;</span></a>
<a class="sourceLine" id="cb16-138" data-line-number="138">status<span class="kw">)</span></a>
<a class="sourceLine" id="cb16-139" data-line-number="139">        <span class="ex">function_status_mysql</span></a>
<a class="sourceLine" id="cb16-140" data-line-number="140">        <span class="kw">;;</span></a>
<a class="sourceLine" id="cb16-141" data-line-number="141">*<span class="kw">)</span></a>
<a class="sourceLine" id="cb16-142" data-line-number="142">    <span class="bu">printf</span> <span class="st">&quot;Usage: </span><span class="va">${cmd_path}</span><span class="st">/mysqld {start|stop|restart|status}\n&quot;</span></a>
<a class="sourceLine" id="cb16-143" data-line-number="143"><span class="kw">esac</span></a>
<a class="sourceLine" id="cb16-144" data-line-number="144"></a>
<a class="sourceLine" id="cb16-145" data-line-number="145"><span class="co"># 添加执行权限</span></a>
<a class="sourceLine" id="cb16-146" data-line-number="146">[<span class="ex">root@centos-158</span> 4307]# chmod a+x /data/scheme2/mysql/4307/service/mysqld.sh </a>
<a class="sourceLine" id="cb16-147" data-line-number="147">[<span class="ex">root@centos-158</span> 4307]# chmod a+x /data/scheme2/mysql/4308/service/mysqld.sh</a></code></pre></div>
<h3 id="开机启动-1">开机启动</h3>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb17-1" data-line-number="1">[<span class="ex">root@centos-158</span> 4307]# ln -s /data/scheme2/mysql/4307/service/mysqld.sh /etc/rc.d/init.d/mysql4307     # 添加到init.d目录</a>
<a class="sourceLine" id="cb17-2" data-line-number="2">[<span class="ex">root@centos-158</span> 4307]# chkconfig --add mysql4307                                                       # 添加到sysv</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">[<span class="ex">root@centos-158</span> 4307]# chkconfig mysql4307 on                                                          # 开机启动</a>
<a class="sourceLine" id="cb17-4" data-line-number="4"></a>
<a class="sourceLine" id="cb17-5" data-line-number="5">[<span class="ex">root@centos-158</span> 4307]# cd ../4308</a>
<a class="sourceLine" id="cb17-6" data-line-number="6"></a>
<a class="sourceLine" id="cb17-7" data-line-number="7">[<span class="ex">root@centos-158</span> 4308]# ln -s /data/scheme2/mysql/4308/service/mysqld.sh /etc/rc.d/init.d/mysql4308     # 添加到init.d目录</a>
<a class="sourceLine" id="cb17-8" data-line-number="8">[<span class="ex">root@centos-158</span> 4308]# chkconfig --add mysql4308                                                       # 添加到sysv</a>
<a class="sourceLine" id="cb17-9" data-line-number="9">[<span class="ex">root@centos-158</span> 4308]# chkconfig mysql4308 on                                                          # 开机启动</a></code></pre></div>
<h3 id="启动服务和查看状态">启动服务和查看状态</h3>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb18-1" data-line-number="1">[<span class="ex">root@centos-158</span> 4307]# service mysql4307 start                     # 启动实例</a>
<a class="sourceLine" id="cb18-2" data-line-number="2">[<span class="ex">root@centos-158</span> 4307]# service mysql4308 start                     # 启动实例      </a>
<a class="sourceLine" id="cb18-3" data-line-number="3">[<span class="ex">root@centos-158</span> 4307]# netstat -tunlp <span class="kw">|</span><span class="fu">grep</span> 430                    # 查看状态</a>
<a class="sourceLine" id="cb18-4" data-line-number="4"><span class="ex">tcp6</span>       0      0 :::4307                 :::*                    LISTEN      8221/mysqld         </a>
<a class="sourceLine" id="cb18-5" data-line-number="5"><span class="ex">tcp6</span>       0      0 :::4308                 :::*                    LISTEN      8369/mysqld </a></code></pre></div>
<h3 id="安全初始化">安全初始化</h3>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb19-1" data-line-number="1">[<span class="ex">root@centos-158</span> 4307]# mysql_secure_installation  -u root  -S /data/scheme2/mysql/4307/socket/mariadb.sock <span class="co"># 安全初始化，参考方案1</span></a>
<a class="sourceLine" id="cb19-2" data-line-number="2">[<span class="ex">root@centos-158</span> 4307]# mysql_secure_installation  -u root  -S /data/scheme2/mysql/4308/socket/mariadb.sock <span class="co"># 安全初始化，参考方案1</span></a></code></pre></div>
<h3 id="服务文件修改密码">服务文件修改密码</h3>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb20-1" data-line-number="1">[<span class="ex">root@centos-158</span> 4307]# vim service/mysqld.sh               # 修改文件的密码项为上面的安装初始化指定的密码</a>
<a class="sourceLine" id="cb20-2" data-line-number="2"><span class="va">mysql_pwd=</span><span class="st">&quot;xxxxx&quot;</span></a>
<a class="sourceLine" id="cb20-3" data-line-number="3">[<span class="ex">root@centos-158</span> 4307]# chmod 750 service/mysqld.sh         # 带有密码设置下权限</a>
<a class="sourceLine" id="cb20-4" data-line-number="4">[<span class="ex">root@centos-158</span> 4307]# cd ../4308                          </a>
<a class="sourceLine" id="cb20-5" data-line-number="5">[<span class="ex">root@centos-158</span> 4308]# vim service/mysqld.sh               # 修改文件的密码项为上面的安装初始化指定的密码</a>
<a class="sourceLine" id="cb20-6" data-line-number="6"><span class="va">mysql_pwd=</span><span class="st">&quot;xxxxx&quot;</span></a>
<a class="sourceLine" id="cb20-7" data-line-number="7">[<span class="ex">root@centos-158</span> 4308]# chmod 750 service/mysqld.sh         # 带有密码设置下权限</a></code></pre></div>
<h2 id="方案3-systemd">方案3-systemd</h2>
<h3 id="创建目录并修改权限-2">创建目录并修改权限</h3>
<p>这种方式，需要每个配置文件都要单独存放，可以给目录更详细的规划下</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb21-1" data-line-number="1">[<span class="ex">root@centos-158</span> ~]# mkdir -pv /data/scheme3/mysql/<span class="dt">{5307,5308}/{data,log,socket,pid}</span>        # 创建目录</a>
<a class="sourceLine" id="cb21-2" data-line-number="2">[<span class="ex">root@centos-158</span> ~]# chown mysql.mysql /data/scheme3/mysql/5307 -R                          # 所有者修改</a>
<a class="sourceLine" id="cb21-3" data-line-number="3">[<span class="ex">root@centos-158</span> ~]# chown mysql.mysql /data/scheme3/mysql/5308 -R                          # 所有者修改</a></code></pre></div>
<h3 id="安装数据库-2">安装数据库</h3>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb22-1" data-line-number="1">[<span class="ex">root@centos-158</span> ~]# mysql_install_db  --datadir=/data/scheme3/mysql/5307/data --basedir=/usr --user=mysql  # 安装数据库</a>
<a class="sourceLine" id="cb22-2" data-line-number="2">[<span class="ex">root@centos-158</span> ~]# mysql_install_db  --datadir=/data/scheme3/mysql/5308/data --basedir=/usr --user=mysql  # 安装数据库</a></code></pre></div>
<h3 id="配置配置文件-1">配置配置文件</h3>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb23-1" data-line-number="1">[<span class="ex">root@centos-158</span> ~]# mv /etc/my.cnf /etc/my.cnf.multi                       # 原有配置文件重名</a>
<a class="sourceLine" id="cb23-2" data-line-number="2">[<span class="ex">root@centos-158</span> system]# cd /etc/my.cnf.d/                                 # 进入conf.d目录</a>
<a class="sourceLine" id="cb23-3" data-line-number="3"></a>
<a class="sourceLine" id="cb23-4" data-line-number="4">[<span class="ex">root@centos-158</span> my.cnf.d]# vim my5307.cnf                                  # 编辑这个文件，名字为my<span class="op">&lt;</span>instance_nam<span class="op">&gt;</span>.cnf</a>
<a class="sourceLine" id="cb23-5" data-line-number="5">[<span class="ex">root@centos-158</span> my.cnf.d]# cat my5307.cnf                                  # 检查</a>
<a class="sourceLine" id="cb23-6" data-line-number="6">[<span class="ex">mysqld</span>]</a>
<a class="sourceLine" id="cb23-7" data-line-number="7"><span class="va">datadir=</span>/data/scheme3/mysql/5307/data</a>
<a class="sourceLine" id="cb23-8" data-line-number="8"><span class="va">socket=</span>/data/scheme3/mysql/5307/socket/mariadb.sock</a>
<a class="sourceLine" id="cb23-9" data-line-number="9"><span class="va">port=</span>5307</a>
<a class="sourceLine" id="cb23-10" data-line-number="10"><span class="ex">log-error</span>=/data/scheme3/mysql/5307/log/mariadb.log</a>
<a class="sourceLine" id="cb23-11" data-line-number="11"><span class="ex">pid-file</span>=/data/scheme3/mysql/5307/pid/mariadb.pid</a>
<a class="sourceLine" id="cb23-12" data-line-number="12">[<span class="ex">root@centos-158</span> my.cnf.d]# vim my5308.cnf                                  # 编辑这个文件</a>
<a class="sourceLine" id="cb23-13" data-line-number="13">[<span class="ex">root@centos-158</span> my.cnf.d]# cat my5308.cnf                                  # 检查</a>
<a class="sourceLine" id="cb23-14" data-line-number="14">[<span class="ex">mysql</span>]</a>
<a class="sourceLine" id="cb23-15" data-line-number="15"><span class="va">datadir=</span>/data/scheme3/mysql/5308/data</a>
<a class="sourceLine" id="cb23-16" data-line-number="16"><span class="va">socket=</span>/data/scheme3/mysql/5308/socket/mariadb.sock</a>
<a class="sourceLine" id="cb23-17" data-line-number="17"><span class="va">port=</span>5308</a>
<a class="sourceLine" id="cb23-18" data-line-number="18"><span class="ex">log-error</span>=/data/scheme3/mysql/5308/log/mariadb.log</a>
<a class="sourceLine" id="cb23-19" data-line-number="19"><span class="ex">pid-file</span>=/data/scheme3/mysql/5308/pid/mariadb.pid</a></code></pre></div>
<h3 id="配置systemd">配置systemd</h3>
<div class="sourceCode" id="cb24"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb24-1" data-line-number="1">[<span class="ex">root@centos-158</span> my.cnf.d]# vim /usr/lib/systemd/system/mariadb@.service        # 修改mariadb@service文件默认项</a>
<a class="sourceLine" id="cb24-2" data-line-number="2"><span class="co"># 修改如下内容</span></a>
<a class="sourceLine" id="cb24-3" data-line-number="3"><span class="va">ConditionPathExists=</span>/etc/my.cnf.d/my%I.cnf</a>
<a class="sourceLine" id="cb24-4" data-line-number="4"></a>
<a class="sourceLine" id="cb24-5" data-line-number="5"><span class="va">ExecStartPre=</span>/bin/sh <span class="ex">-c</span> <span class="st">&quot;[ ! -e /usr/bin/galera_recovery ] &amp;&amp; VAR= || \</span></a>
<a class="sourceLine" id="cb24-6" data-line-number="6"><span class="st">VAR=</span><span class="kw">`</span><span class="ex">/usr/bin/galera_recovery</span> --defaults-file=/etc/my.cnf.d/my%I.cnf<span class="kw">`</span><span class="st">; [ </span><span class="va">$?</span><span class="st"> -eq 0 ] \</span></a>
<a class="sourceLine" id="cb24-7" data-line-number="7"><span class="st">&amp;&amp; systemctl set-environment _WSREP_START_POSITION%I=</span><span class="va">$VAR</span><span class="st"> || exit 1&quot;</span></a>
<a class="sourceLine" id="cb24-8" data-line-number="8"></a>
<a class="sourceLine" id="cb24-9" data-line-number="9"><span class="va">ExecStart=</span>/usr/sbin/mysqld <span class="ex">--defaults-file</span>=/etc/my.cnf.d/my%I.cnf \</a>
<a class="sourceLine" id="cb24-10" data-line-number="10"><span class="va">$_WSREP_NEW_CLUSTER</span> <span class="va">$_WSREP_START_POSITION</span>%I <span class="va">$MYSQLD_OPTS</span></a></code></pre></div>
<p>上面的简单的说就是说明下mysqld命令的路径，指定你的实例所在的路径%I代表实例名字。后续启动的 &quot;systemctl start mariadb@5307&quot; 这个命令中，5307就是实例名字。</p>
<p>这个文件有点多， 提供一个下载参考吧。</p>
<p><span data-role="download">/files/mariadb@.service</span></p>
<h3 id="启动服务和查看状态-1">启动服务和查看状态</h3>
<div class="sourceCode" id="cb25"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb25-1" data-line-number="1">[<span class="ex">root@centos-158</span> my.cnf.d]# systemctl daemon-reload                 # 重载systemd</a>
<a class="sourceLine" id="cb25-2" data-line-number="2">[<span class="ex">root@centos-158</span> my.cnf.d]# systemctl start mariadb@5307            # 启动实例</a>
<a class="sourceLine" id="cb25-3" data-line-number="3">[<span class="ex">root@centos-158</span> my.cnf.d]# systemctl start mariadb@5308            # 启动实例</a>
<a class="sourceLine" id="cb25-4" data-line-number="4">[<span class="ex">root@centos-158</span> my.cnf.d]# netstat -tunlp <span class="kw">|</span><span class="fu">grep</span> 530                # 查看服务状态</a>
<a class="sourceLine" id="cb25-5" data-line-number="5"><span class="ex">tcp6</span>       0      0 :::5307                 :::*                    LISTEN      10267/mysqld        </a>
<a class="sourceLine" id="cb25-6" data-line-number="6"><span class="ex">tcp6</span>       0      0 :::5308                 :::*                    LISTEN      10595/mysqld  </a></code></pre></div>
<h3 id="开机启动-2">开机启动</h3>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb26-1" data-line-number="1">[<span class="ex">root@centos-158</span> my.cnf.d]# systemctl enable  mariadb@5307           # 开机启动这个实例</a>
<a class="sourceLine" id="cb26-2" data-line-number="2"><span class="ex">Created</span> symlink from /etc/systemd/system/multi-user.target.wants/mariadb@5307.service to /usr/lib/systemd/system/mariadb@.service.</a>
<a class="sourceLine" id="cb26-3" data-line-number="3">[<span class="ex">root@centos-158</span> my.cnf.d]# systemctl enable  mariadb@5308           # 开机启动这个实例</a>
<a class="sourceLine" id="cb26-4" data-line-number="4"><span class="ex">Created</span> symlink from /etc/systemd/system/multi-user.target.wants/mariadb@5308.service to /usr/lib/systemd/system/mariadb@.service.</a></code></pre></div>
<h3 id="安全初始化-1">安全初始化</h3>
<div class="sourceCode" id="cb27"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb27-1" data-line-number="1">[<span class="ex">root@centos-158</span> ~]# mysql_secure_installation  -u root  -S /data/scheme3/mysql/5307/socket/mariadb.sock    # 安全设置</a>
<a class="sourceLine" id="cb27-2" data-line-number="2">[<span class="ex">root@centos-158</span> ~]# mysql_secure_installation  -u root  -S /data/scheme3/mysql/5308/socket/mariadb.sock    # 安全设置</a></code></pre></div>
]]></content>
      
        <categories>
            
            <category> database </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> mysql </tag>
            
            <tag> mariadb </tag>
            
        </tags>
        
    </entry>
    
  
  
</search>
